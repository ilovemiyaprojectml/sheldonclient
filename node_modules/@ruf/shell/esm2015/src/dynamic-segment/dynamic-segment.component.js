import * as tslib_1 from "tslib";
import { Component, ContentChild, TemplateRef, ViewEncapsulation, ChangeDetectionStrategy, EventEmitter, Input, Output, ElementRef, ViewChildren, QueryList, HostListener } from '@angular/core';
import { MatButtonToggle } from '@angular/material/button-toggle';
import { RufKeyboardNavigation } from '../input/keyboard';
let RufDynamicSegmentComponent = class RufDynamicSegmentComponent {
    constructor(_elementRef) {
        this._elementRef = _elementRef;
        this.items = [];
        /* tslint:disable:no-output-rename */
        // Renaming output to avoid duplicate `select` identifiers
        this.selectEmitter = new EventEmitter();
    }
    set selectedPath(id) {
        this._selectedPath = id;
    }
    get selectedPath() {
        return this._selectedPath;
    }
    ngAfterViewInit() {
        this.addNewKeyboardNav();
        this.segmentItems.changes.subscribe(() => {
            this.addNewKeyboardNav();
        });
    }
    onKey(event) {
        this._keyboardNav.onKeyDown(event);
    }
    ngOnChanges(changes) {
        if (changes.selectedPath && changes.selectedPath.currentValue) {
            this.selectSegmentItem({ path: changes.selectedPath.currentValue });
        }
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    // Set Keyboard navigation
    addNewKeyboardNav() {
        this._keyboardNav = new RufKeyboardNavigation();
        this.subscription = this._keyboardNav.init(this._elementRef, this.segmentItems).subscribe(item => {
            this.selectSegmentItem({ path: item.value });
        });
        this._keyboardNav.addTabIndex(this.segmentItems);
    }
    /**
     * Set selectedPath and activate dynamic-segment item
     * @param item
     */
    selectSegmentItem(item) {
        this._selectedPath = item.path;
        const selectedIndex = this.selectedIndex();
        if (this._keyboardNav) {
            this._keyboardNav.setActiveItem((selectedIndex === -1) ? 0 : selectedIndex);
        }
        if (this.segmentItems) {
            // if segmentItems are not present, the component view is not loaded yet.
            // This means 'selectSegmentItem' is called from 'ngOnChanges' and the host element has [selectedPath] input.
            const selectedItem = (selectedIndex === -1) ? null : this.items[selectedIndex];
            this.selectEmitter.emit(selectedItem);
        }
    }
    /**
     * @returns - index of the selected dynamic-segment item. -1 if no dynamic-segment is selected.
     */
    selectedIndex() {
        let index = -1;
        if (this.segmentItems) {
            index = this.items.findIndex((segmentItem, i) => this._matches(segmentItem.path));
        }
        return index;
    }
    _matches(path) {
        if (path && this.selectedPath) {
            const pattern = new RegExp('^((\/)?' + this.selectedPath + ')(\/.*)?$'); // use word boundary to exact match
            if (path === this.selectedPath || pattern.test(path)) { // match with and parent dynamic-segment item
                return true;
            }
        }
        return false;
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Array)
], RufDynamicSegmentComponent.prototype, "items", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], RufDynamicSegmentComponent.prototype, "showActiveItemClip", void 0);
tslib_1.__decorate([
    Output('select'),
    tslib_1.__metadata("design:type", Object)
], RufDynamicSegmentComponent.prototype, "selectEmitter", void 0);
tslib_1.__decorate([
    ViewChildren(MatButtonToggle),
    tslib_1.__metadata("design:type", QueryList)
], RufDynamicSegmentComponent.prototype, "segmentItems", void 0);
tslib_1.__decorate([
    ContentChild(TemplateRef, { static: false }),
    tslib_1.__metadata("design:type", Object)
], RufDynamicSegmentComponent.prototype, "navActions", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String),
    tslib_1.__metadata("design:paramtypes", [String])
], RufDynamicSegmentComponent.prototype, "selectedPath", null);
tslib_1.__decorate([
    HostListener('keydown', ['$event']),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [KeyboardEvent]),
    tslib_1.__metadata("design:returntype", void 0)
], RufDynamicSegmentComponent.prototype, "onKey", null);
RufDynamicSegmentComponent = tslib_1.__decorate([
    Component({
        selector: 'ruf-dynamic-segment',
        template: "<div class=\"segment-layout\" role=\"menubar\">\n  <mat-button-toggle-group rufId=\"segmentGroup\" fisStyle class=\"segment-group\" value=\"{{selectedPath}}\">\n    <mat-button-toggle rufId class=\"segment-item\"\n                       [class.mat-button-toggle-selected]=\"selectedPath === item.path ? true : false\"\n                       [class.mat-button-toggle-checked]=\"selectedPath === item.path ? true : false\"\n                       [class.segment-clip]=\"showActiveItemClip\"\n                       fisStyle\n                       *ngFor=\"let item of items\"\n                       (click)=\"selectSegmentItem(item)\"\n                       value=\"{{item.path}}\"\n                       title=\"{{item.tooltipText}}\"\n                       role=\"menuitem\">\n      {{item.label}}\n      <ng-template [ngTemplateOutlet]=\"navActions\" [ngTemplateOutletContext]=\"{item: item}\">\n      </ng-template>\n    </mat-button-toggle>\n  </mat-button-toggle-group>\n</div>\n",
        encapsulation: ViewEncapsulation.None,
        changeDetection: ChangeDetectionStrategy.OnPush,
        styles: [".segment-layout{-webkit-box-align:stretch;align-items:stretch;display:-webkit-box;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.segment-layout .mat-button-toggle-group{overflow:visible}.segment-item:focus{outline:0}.segment-item>label{cursor:pointer;text-align:center;width:100%}.segment-group>.segment-item{-webkit-box-align:center;align-items:center;border-bottom-style:solid;border-bottom-width:.125rem;border-color:transparent;border-top-style:solid;border-top-width:.125rem;cursor:pointer;display:-webkit-box;display:flex;-webkit-box-flex:1;flex:1 auto;-webkit-box-pack:center;justify-content:center;padding:0;-webkit-transition:background-color .2s;transition:background-color .2s}.segment-group>.segment-clip::after{border-left:10px solid transparent;border-right:10px solid transparent;border-top:15px solid transparent;content:'';left:calc(50% - 10px);position:absolute;top:100%}"]
    }),
    tslib_1.__metadata("design:paramtypes", [ElementRef])
], RufDynamicSegmentComponent);
export { RufDynamicSegmentComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1zZWdtZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BydWYvc2hlbGwvIiwic291cmNlcyI6WyJzcmMvZHluYW1pYy1zZWdtZW50L2R5bmFtaWMtc2VnbWVudC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLFdBQVcsRUFDWCxpQkFBaUIsRUFDakIsdUJBQXVCLEVBQ3ZCLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUVOLFVBQVUsRUFJVixZQUFZLEVBQ1osU0FBUyxFQUNULFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFHbEUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFTMUQsSUFBYSwwQkFBMEIsR0FBdkMsTUFBYSwwQkFBMEI7SUF3QnJDLFlBQXNCLFdBQXVCO1FBQXZCLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBbEJwQyxVQUFLLEdBQTRCLEVBQUUsQ0FBQztRQUU3QyxxQ0FBcUM7UUFDckMsMERBQTBEO1FBQ3hDLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQXlCLENBQUM7SUFjM0IsQ0FBQztJQVJsRCxJQUFJLFlBQVksQ0FBQyxFQUFVO1FBQ3pCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFRCxJQUFJLFlBQVk7UUFDZCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDNUIsQ0FBQztJQUlELGVBQWU7UUFDYixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUdELEtBQUss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Q3BDO0lBQVIsS0FBSyxFQUFFOztzRUFBNkI7QUFHbkI7SUFBakIsTUFBTSxDQUFDLFFBQVEsQ0FBQzs7aUVBQTJEO0FBRTdDO0lBQTlCLFlBQVksQ0FBQyxlQUFlLENBQUM7c0NBQWUsU0FBUztnRUFBa0I7QUFDNUI7SUFBM0MsWUFBWSxDQUFDLFdBQVcsRUFBRSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUMsQ0FBQzs7OERBQVk7QUFHdkQ7SUFEQyxLQUFLLEVBQUU7Ozs4REFHUDtBQWdCRDtJQURDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7NkNBQ3ZCLGFBQWE7O3VEQUV6QjtBQXBDVSwwQkFBMEI7SUFQdEMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLHFCQUFxQjtRQUMvQix5K0JBQStDO1FBRS9DLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO1FBQ3JDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOztLQUNoRCxDQUFDOzZDQXlCbUMsVUFBVTtHQXhCbEMsMEJBQTBCLENBaUd0QztTQWpHWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZCxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBBZnRlclZpZXdJbml0LFxuICBFbGVtZW50UmVmLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkcmVuLFxuICBRdWVyeUxpc3QsXG4gIEhvc3RMaXN0ZW5lclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBNYXRCdXR0b25Ub2dnbGUgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9idXR0b24tdG9nZ2xlJztcblxuaW1wb3J0IHsgUnVmRHluYW1pY1NlZ21lbnRJdGVtIH0gZnJvbSAnLi9keW5hbWljLXNlZ21lbnQtaXRlbS5tb2RlbCc7XG5pbXBvcnQgeyBSdWZLZXlib2FyZE5hdmlnYXRpb24gfSBmcm9tICcuLi9pbnB1dC9rZXlib2FyZCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3J1Zi1keW5hbWljLXNlZ21lbnQnLFxuICB0ZW1wbGF0ZVVybDogJy4vZHluYW1pYy1zZWdtZW50LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZHluYW1pYy1zZWdtZW50LmNvbXBvbmVudC5zY3NzJ10sXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIFJ1ZkR5bmFtaWNTZWdtZW50Q29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIF9rZXlib2FyZE5hdjogUnVmS2V5Ym9hcmROYXZpZ2F0aW9uO1xuICBwcml2YXRlIF9zZWxlY3RlZFBhdGg6IHN0cmluZztcbiAgcHJpdmF0ZSBhdGl2ZUl0ZW1DbGlwOiBib29sZWFuO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbjtcblxuICBASW5wdXQoKSBpdGVtczogUnVmRHluYW1pY1NlZ21lbnRJdGVtW10gPSBbXTtcbiAgQElucHV0KCkgc2hvd0FjdGl2ZUl0ZW1DbGlwOiBib29sZWFuO1xuICAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1vdXRwdXQtcmVuYW1lICovXG4gIC8vIFJlbmFtaW5nIG91dHB1dCB0byBhdm9pZCBkdXBsaWNhdGUgYHNlbGVjdGAgaWRlbnRpZmllcnNcbiAgQE91dHB1dCgnc2VsZWN0Jykgc2VsZWN0RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXI8UnVmRHluYW1pY1NlZ21lbnRJdGVtPigpO1xuXG4gIEBWaWV3Q2hpbGRyZW4oTWF0QnV0dG9uVG9nZ2xlKSBzZWdtZW50SXRlbXM6IFF1ZXJ5TGlzdDxNYXRCdXR0b25Ub2dnbGU+O1xuICBAQ29udGVudENoaWxkKFRlbXBsYXRlUmVmLCB7c3RhdGljOiBmYWxzZX0pIG5hdkFjdGlvbnM7XG5cbiAgQElucHV0KClcbiAgc2V0IHNlbGVjdGVkUGF0aChpZDogc3RyaW5nKSB7XG4gICAgdGhpcy5fc2VsZWN0ZWRQYXRoID0gaWQ7XG4gIH1cblxuICBnZXQgc2VsZWN0ZWRQYXRoKCkge1xuICAgIHJldHVybiB0aGlzLl9zZWxlY3RlZFBhdGg7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgX2VsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHsgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmFkZE5ld0tleWJvYXJkTmF2KCk7XG4gICAgdGhpcy5zZWdtZW50SXRlbXMuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5hZGROZXdLZXlib2FyZE5hdigpO1xuICAgIH0pO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIG9uS2V5KGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgdGhpcy5fa2V5Ym9hcmROYXYub25LZXlEb3duKGV2ZW50KTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5zZWxlY3RlZFBhdGggJiYgY2hhbmdlcy5zZWxlY3RlZFBhdGguY3VycmVudFZhbHVlKSB7XG4gICAgICB0aGlzLnNlbGVjdFNlZ21lbnRJdGVtKHtwYXRoOiBjaGFuZ2VzLnNlbGVjdGVkUGF0aC5jdXJyZW50VmFsdWV9KTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLy8gU2V0IEtleWJvYXJkIG5hdmlnYXRpb25cbiAgYWRkTmV3S2V5Ym9hcmROYXYoKSB7XG4gICAgdGhpcy5fa2V5Ym9hcmROYXYgPSBuZXcgUnVmS2V5Ym9hcmROYXZpZ2F0aW9uKCk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLl9rZXlib2FyZE5hdi5pbml0KHRoaXMuX2VsZW1lbnRSZWYsIHRoaXMuc2VnbWVudEl0ZW1zKS5zdWJzY3JpYmUoaXRlbSA9PiB7XG4gICAgICB0aGlzLnNlbGVjdFNlZ21lbnRJdGVtKHtwYXRoOiBpdGVtLnZhbHVlfSk7XG4gICAgfSk7XG4gICAgdGhpcy5fa2V5Ym9hcmROYXYuYWRkVGFiSW5kZXgodGhpcy5zZWdtZW50SXRlbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBzZWxlY3RlZFBhdGggYW5kIGFjdGl2YXRlIGR5bmFtaWMtc2VnbWVudCBpdGVtXG4gICAqIEBwYXJhbSBpdGVtXG4gICAqL1xuICBzZWxlY3RTZWdtZW50SXRlbShpdGVtOiBSdWZEeW5hbWljU2VnbWVudEl0ZW0pIHtcbiAgICB0aGlzLl9zZWxlY3RlZFBhdGggPSBpdGVtLnBhdGg7XG4gICAgY29uc3Qgc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0ZWRJbmRleCgpO1xuICAgIGlmICh0aGlzLl9rZXlib2FyZE5hdikge1xuICAgICAgdGhpcy5fa2V5Ym9hcmROYXYuc2V0QWN0aXZlSXRlbSgoc2VsZWN0ZWRJbmRleCA9PT0gLTEpID8gMCA6IHNlbGVjdGVkSW5kZXgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zZWdtZW50SXRlbXMpIHtcbiAgICAgIC8vIGlmIHNlZ21lbnRJdGVtcyBhcmUgbm90IHByZXNlbnQsIHRoZSBjb21wb25lbnQgdmlldyBpcyBub3QgbG9hZGVkIHlldC5cbiAgICAgIC8vIFRoaXMgbWVhbnMgJ3NlbGVjdFNlZ21lbnRJdGVtJyBpcyBjYWxsZWQgZnJvbSAnbmdPbkNoYW5nZXMnIGFuZCB0aGUgaG9zdCBlbGVtZW50IGhhcyBbc2VsZWN0ZWRQYXRoXSBpbnB1dC5cbiAgICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IChzZWxlY3RlZEluZGV4ID09PSAtMSkgPyBudWxsIDogdGhpcy5pdGVtc1tzZWxlY3RlZEluZGV4XTtcbiAgICAgIHRoaXMuc2VsZWN0RW1pdHRlci5lbWl0KHNlbGVjdGVkSXRlbSk7XG4gICAgfVxuXG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgLSBpbmRleCBvZiB0aGUgc2VsZWN0ZWQgZHluYW1pYy1zZWdtZW50IGl0ZW0uIC0xIGlmIG5vIGR5bmFtaWMtc2VnbWVudCBpcyBzZWxlY3RlZC5cbiAgICovXG4gIHNlbGVjdGVkSW5kZXgoKTogbnVtYmVyIHtcbiAgICBsZXQgaW5kZXggPSAtMTtcbiAgICBpZiAodGhpcy5zZWdtZW50SXRlbXMpIHtcbiAgICAgIGluZGV4ID0gdGhpcy5pdGVtcy5maW5kSW5kZXgoIChzZWdtZW50SXRlbSwgaSkgPT4gdGhpcy5fbWF0Y2hlcyhzZWdtZW50SXRlbS5wYXRoKSk7XG4gICAgfVxuICAgIHJldHVybiBpbmRleDtcbiAgfVxuXG4gIHByaXZhdGUgX21hdGNoZXMocGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKHBhdGggJiYgdGhpcy5zZWxlY3RlZFBhdGgpIHtcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeKChcXC8pPycgKyB0aGlzLnNlbGVjdGVkUGF0aCArICcpKFxcLy4qKT8kJyk7ICAvLyB1c2Ugd29yZCBib3VuZGFyeSB0byBleGFjdCBtYXRjaFxuICAgICAgaWYgKHBhdGggPT09IHRoaXMuc2VsZWN0ZWRQYXRoIHx8IHBhdHRlcm4udGVzdChwYXRoKSkgeyAvLyBtYXRjaCB3aXRoIGFuZCBwYXJlbnQgZHluYW1pYy1zZWdtZW50IGl0ZW1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG59XG4iXX0=