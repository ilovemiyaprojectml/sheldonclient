/**The MIT License

Copyright (c) 2017 Google, Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
import { FocusKeyManager, ListKeyManager } from '@angular/cdk/a11y';
// Focusable interface renamed to FocusableOption in @angular/cdk beta-10.
import { Subject } from 'rxjs';
import { HOME, END } from '@angular/cdk/keycodes';
export class RufKeyCodes {
}
RufKeyCodes.ENTER = 13;
RufKeyCodes.ESCAPE = 27;
RufKeyCodes.SPACE = 32;
RufKeyCodes.LEFT_ARROW = 37;
RufKeyCodes.UP_ARROW = 38;
RufKeyCodes.RIGHT_ARROW = 39;
RufKeyCodes.DOWN_ARROW = 40;
export class RufKeyboardNavigation {
    constructor() {
        this._direction = 'row';
    }
    // To receive select notifications, subscribe to this function
    init(container, items) {
        this._container = container;
        this._items = items;
        this._FocusKeyManager = new FocusKeyManager(items).withWrap();
        this._ListKeyManager = new ListKeyManager(items);
        if (items.length > 0) {
            this.setActiveItemWithoutFocus(0);
            this._ListKeyManager.setActiveItem.call(this._FocusKeyManager, 0);
        }
        this._subscription = new Subject();
        return this._subscription;
    }
    setActiveItem(index) {
        this._FocusKeyManager.setActiveItem(index);
    }
    setActiveItemWithoutFocus(index) {
        this._ListKeyManager.setActiveItem.call(this._FocusKeyManager, index);
    }
    navigate(event) {
        switch (event.keyCode) {
            case RufKeyCodes.ESCAPE:
                this._container.nativeElement.focus();
                break;
            case RufKeyCodes.LEFT_ARROW:
            case RufKeyCodes.UP_ARROW:
                this._FocusKeyManager.setPreviousItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case RufKeyCodes.RIGHT_ARROW:
            case RufKeyCodes.DOWN_ARROW:
                this._FocusKeyManager.setNextItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case RufKeyCodes.SPACE:
            case RufKeyCodes.ENTER:
                this.selectFocusedItem();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case HOME:
                this._FocusKeyManager.setFirstItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case END:
                this._FocusKeyManager.setLastItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            default:
                this._FocusKeyManager.onKeydown(event);
                break;
        }
    }
    preventEventPropagation(event) {
        event.preventDefault();
        event.stopPropagation();
    }
    onKeyDown(event) {
        if (this._items.length === 0) {
            return;
        }
        this.navigate(event);
    }
    addTabIndex(focusableItems) {
        focusableItems.forEach((child, index) => {
            if (index === 0) {
                child._elementRef.nativeElement.setAttribute('tabindex', 0);
            }
            else {
                child._elementRef.nativeElement.setAttribute('tabindex', -1);
            }
        });
    }
    selectFocusedItem() {
        if (this._FocusKeyManager.activeItem) {
            this._subscription.next(this._FocusKeyManager.activeItem);
        }
    }
    focus(path) {
        if (!this._items || this._items.length === 0) {
            return;
        }
        const item = this._items.find(f => f.path === path);
        const index = this._items.toArray().indexOf(item);
        this._FocusKeyManager.setActiveItem(index);
    }
    isActive() {
        return this._FocusKeyManager.activeItem !== undefined;
    }
    setDirection(direction) {
        if (direction === 'column') {
            this._direction = direction;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5Ym9hcmQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcnVmL3NoZWxsLyIsInNvdXJjZXMiOlsic3JjL2lucHV0L2tleWJvYXJkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7RUFxQkU7QUFHRixPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBbUIsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRiwwRUFBMEU7QUFDMUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQXVFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUV2SCxNQUFNLE9BQU8sV0FBVzs7QUFDTixpQkFBSyxHQUFHLEVBQUUsQ0FBQztBQUNYLGtCQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ1osaUJBQUssR0FBRyxFQUFFLENBQUM7QUFDWCxzQkFBVSxHQUFHLEVBQUUsQ0FBQztBQUNoQixvQkFBUSxHQUFHLEVBQUUsQ0FBQztBQUNkLHVCQUFXLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLHNCQUFVLEdBQUcsRUFBRSxDQUFDO0FBR2xDLE1BQU0sT0FBTyxxQkFBcUI7SUFBbEM7UUFNVSxlQUFVLEdBQUcsS0FBSyxDQUFDO0lBNEc3QixDQUFDO0lBMUdDLDhEQUE4RDtJQUM5RCxJQUFJLENBQUMsU0FBcUIsRUFBRSxLQUFxQjtRQUMvQyxJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDOUQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLElBQUksQ0FBQyx5QkFBeUIs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QUM3RDtpQkFBTTtnQkFDTCxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDOUQ7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFO1lBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMzRDtJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsSUFBWTtRQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDNUMsT0FBTztTQUNSO1FBQ0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVNLFFBQVE7UUFDYixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDO0lBQ3hELENBQUM7SUFDTSxZQUFZLENBQUMsU0FBaUI7UUFDbkMsSUFBSSxTQUFTLEtBQUssUUFBUSxFQUFFO1lBQzFCLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1NBQzdCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLyoqVGhlIE1JVCBMaWNlbnNlXG5cbkNvcHlyaWdodCAoYykgMjAxNyBHb29nbGUsIEluYy5cblxuUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxub2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xudG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG5mdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuXG5UaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG5cblRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbklNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG5BVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG5MSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuVEhFIFNPRlRXQVJFLlxuKi9cblxuaW1wb3J0IHsgUXVlcnlMaXN0LCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb2N1c0tleU1hbmFnZXIsIExpc3RLZXlNYW5hZ2VyLCBGb2N1c2FibGVPcHRpb24gfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG4vLyBGb2N1c2FibGUgaW50ZXJmYWNlIHJlbmFtZWQgdG8gRm9jdXNhYmxlT3B0aW9uIGluIEBhbmd1bGFyL2NkayBiZXRhLTEwLlxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTEVGVF9BUlJPVywgUklHSFRfQVJST1csIERPV05fQVJST1csIFVQX0FSUk9XLCBFTlRFUiwgU1BBQ0UsIEVTQ0FQRSwgSE9NRSwgRU5EIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2tleWNvZGVzJztcblxuZXhwb3J0IGNsYXNzIFJ1ZktleUNvZGVzIHtcbiAgc3RhdGljIHJlYWRvbmx5IEVOVEVSID0gMTM7XG4gIHN0YXRpYyByZWFkb25seSBFU0NBUEUgPSAyNztcbiAgc3RhdGljIHJlYWRvbmx5IFNQQUNFID0gMzI7XG4gIHN0YXRpYyByZWFkb25seSBMRUZUX0FSUk9XID0gMzc7XG4gIHN0YXRpYyByZWFkb25seSBVUF9BUlJPVyA9IDM4O1xuICBzdGF0aWMgcmVhZG9ubHkgUklHSFRfQVJST1cgPSAzOTtcbiAgc3RhdGljIHJlYWRvbmx5IERPV05fQVJST1cgPSA0MDtcbn1cblxuZXhwb3J0IGNsYXNzIFJ1ZktleWJvYXJkTmF2aWdhdGlvbiB7XG4gIHByaXZhdGUgX0ZvY3VzS2V5TWFuYWdlcjogRm9jdXNLZXlNYW5hZ2VyPEZvY3VzYWJsZU9wdGlvbj47XG4gIHByaXZhdGUgX0xpc3RLZXlNYW5hZ2VyOiBMaXN0S2V5TWFuYWdlcjxGb2N1c2FibGVPcHRpb24+O1xuICBwcml2YXRlIF9zdWJzY3JpcHRpb246IFN1YmplY3Q8YW55PjtcbiAgcHJpdmF0ZSBfY29udGFpbmVyOiBFbGVtZW50UmVmO1xuICBwcml2YXRlIF9pdGVtczogUXVlcnlMaXN0PGFueT47XG4gIHByaXZhdGUgX2RpcmVjdGlvbiA9ICdyb3cnO1xuXG4gIC8vIFRvIHJlY2VpdmUgc2VsZWN0IG5vdGlmaWNhdGlvbnMsIHN1YnNjcmliZSB0byB0aGlzIGZ1bmN0aW9uXG4gIGluaXQoY29udGFpbmVyOiBFbGVtZW50UmVmLCBpdGVtczogUXVlcnlMaXN0PGFueT4pOiBTdWJqZWN0PGFueT4ge1xuICAgIHRoaXMuX2NvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICB0aGlzLl9pdGVtcyA9IGl0ZW1zO1xuICAgIHRoaXMuX0ZvY3VzS2V5TWFuYWdlciA9IG5ldyBGb2N1c0tleU1hbmFnZXIoaXRlbXMpLndpdGhXcmFwKCk7XG4gICAgdGhpcy5fTGlzdEtleU1hbmFnZXIgPSBuZXcgTGlzdEtleU1hbmFnZXIoaXRlbXMpO1xuICAgIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnNldEFjdGl2ZUl0ZW1XaXRob3V0Rm9jdXMoMCk7XG4gICAgICB0aGlzLl9MaXN0S2V5TWFuYWdlci5zZXRBY3RpdmVJdGVtLmNhbGwodGhpcy5fRm9jdXNLZXlNYW5hZ2VyLCAwKTtcbiAgICB9XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpcHRpb247XG4gIH1cblxuICBzZXRBY3RpdmVJdGVtKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0QWN0aXZlSXRlbShpbmRleCk7XG4gIH1cblxuICBzZXRBY3RpdmVJdGVtV2l0aG91dEZvY3VzKGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLl9MaXN0S2V5TWFuYWdlci5zZXRBY3RpdmVJdGVtLmNhbGwodGhpcy5fRm9jdXNLZXlNYW5hZ2VyLCBpbmRleCk7XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgc3dpdGNoIChldmVudC5rZXlDb2RlKSB7XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLkVTQ0FQRTpcbiAgICAgICAgdGhpcy5fY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLkxFRlRfQVJST1c6XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLlVQX0FSUk9XOlxuICAgICAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0UHJldmlvdXNJdGVtQWN0aXZlKCk7XG4gICAgICAgIC8vIHByZXZlbnQgc2Nyb2xsYmFyIGNhdGNoaW5nIHRoZSBldmVudFxuICAgICAgICB0aGlzLnByZXZlbnRFdmVudFByb3BhZ2F0aW9uKGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLlJJR0hUX0FSUk9XOlxuICAgICAgY2FzZSBSdWZLZXlDb2Rlcy5ET1dOX0FSUk9XOlxuICAgICAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0TmV4dEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgY2F0Y2hpbmcgdGhlIGV2ZW50XG4gICAgICAgIHRoaXMucHJldmVudEV2ZW50UHJvcGFnYXRpb24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUnVmS2V5Q29kZXMuU1BBQ0U6XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLkVOVEVSOlxuICAgICAgICB0aGlzLnNlbGVjdEZvY3VzZWRJdGVtKCk7XG4gICAgICAgIC8vIHByZXZlbnQgc2Nyb2xsYmFyIGNhdGNoaW5nIHRoZSBldmVudFxuICAgICAgICB0aGlzLnByZXZlbnRFdmVudFByb3BhZ2F0aW9uKGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEhPTUU6XG4gICAgICAgIHRoaXMuX0ZvY3VzS2V5TWFuYWdlci5zZXRGaXJzdEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgY2F0Y2hpbmcgdGhlIGV2ZW50XG4gICAgICAgIHRoaXMucHJldmVudEV2ZW50UHJvcGFnYXRpb24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRU5EOlxuICAgICAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0TGFzdEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgY2F0Y2hpbmcgdGhlIGV2ZW50XG4gICAgICAgIHRoaXMucHJldmVudEV2ZW50UHJvcGFnYXRpb24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuX0ZvY3VzS2V5TWFuYWdlci5vbktleWRvd24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHByZXZlbnRFdmVudFByb3BhZ2F0aW9uKGV2ZW50KSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgfVxuXG4gIG9uS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm5hdmlnYXRlKGV2ZW50KTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRUYWJJbmRleChmb2N1c2FibGVJdGVtcykge1xuICAgIGZvY3VzYWJsZUl0ZW1zLmZvckVhY2goKGNoaWxkLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgIGNoaWxkLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsIDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2hpbGQuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywgLTEpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RGb2N1c2VkSXRlbSgpIHtcbiAgICBpZiAodGhpcy5fRm9jdXNLZXlNYW5hZ2VyLmFjdGl2ZUl0ZW0pIHtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbi5uZXh0KHRoaXMuX0ZvY3VzS2V5TWFuYWdlci5hY3RpdmVJdGVtKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZm9jdXMocGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLl9pdGVtcyB8fCB0aGlzLl9pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuX2l0ZW1zLmZpbmQoZiA9PiBmLnBhdGggPT09IHBhdGgpO1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5faXRlbXMudG9BcnJheSgpLmluZGV4T2YoaXRlbSk7XG4gICAgdGhpcy5fRm9jdXNLZXlNYW5hZ2VyLnNldEFjdGl2ZUl0ZW0oaW5kZXgpO1xuICB9XG5cbiAgcHVibGljIGlzQWN0aXZlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuYWN0aXZlSXRlbSAhPT0gdW5kZWZpbmVkO1xuICB9XG4gIHB1YmxpYyBzZXREaXJlY3Rpb24oZGlyZWN0aW9uOiBzdHJpbmcpIHtcbiAgICBpZiAoZGlyZWN0aW9uID09PSAnY29sdW1uJykge1xuICAgICAgdGhpcy5fZGlyZWN0aW9uID0gZGlyZWN0aW9uO1xuICAgIH1cbiAgfVxufVxuIl19