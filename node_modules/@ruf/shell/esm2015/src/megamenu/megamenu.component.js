import * as tslib_1 from "tslib";
import { RufSidemenuComponent } from './../sidemenu/sidemenu.component';
import { RufSearchService } from './menu-search.service';
import { ChangeDetectorRef, Component, Input, Output, EventEmitter, ViewEncapsulation, ViewChild, ChangeDetectionStrategy } from '@angular/core';
import { Subject, merge, of } from 'rxjs';
import { debounceTime, distinctUntilChanged, map, startWith, switchMap, withLatestFrom } from 'rxjs/operators';
import { RufShellIntl } from '../utils/shell-intl';
let RufMegamenuComponent = class RufMegamenuComponent {
    constructor(searchService, _intl, changeDetectorRef) {
        this.searchService = searchService;
        this._intl = _intl;
        this.items = [];
        this.select = new EventEmitter();
        // Subjects: denotes user interaction streams
        // search related properties
        this.searchTerms$ = new Subject(); // stream of search terms
        // sidemenu select event stream
        this.selectedSidemenuItems$ = new Subject(); // stream of selected items (same type has this.items)
        this.preparedSearchableItems = (term) => [];
        this._intlChanges = _intl.changes.subscribe(() => changeDetectorRef.markForCheck());
    }
    get searchPlaceholder() {
        return this._searchPlaceholder || this._intl.megamenu.placeholder;
    }
    set searchPlaceholder(value) {
        this._searchPlaceholder = value;
    }
    get clearSearchAriaLabel() {
        return this._clearSearchAriaLabel || this._intl.megamenu.aria.clearSearchLabel;
    }
    set clearSearchAriaLabel(value) {
        this._clearSearchAriaLabel = value;
    }
    ngOnInit() {
        // map search terms to a search results stream ready to be consumed by sitemap
        const searchResults$ = this.searchTerms$.pipe(distinctUntilChanged(), debounceTime(400), // don't search unless user stopped typing for 400ms
        switchMap(term => this.search(term)), // ignore already triggered searches.
        startWith([])); // start with empty results
        // map sidemenu select event to selected item's children array
        const selectedItemChildren$ = this.selectedSidemenuItems$.pipe(withLatestFrom(searchResults$), // combine each event with the latest of the searchResults$ stream
        map(([item, searchResults]) => {
            if (!item) {
                return searchResults || [];
            }
            // map to the selected item's children or an empty array.
            return item.data || [];
        }));
        // sitemap data stream is a merge of search results and selected item's children streams
        this.sitemapItems$ = merge(selectedItemChildren$, searchResults$);
    }
    ngOnChanges(changes) {
        // when any changes to the items occur, re-prepare the search
        if (changes.items && changes.items.currentValue) {
            this.preparedSearchableItems = this.searchService.prepareSearch(changes.items.currentValue);
        }
    }
    ngAfterViewInit() {
        // once the sidemenu is created (after view init), select first sidemenu item
        setTimeout(() => {
            if (this.items[0]) {
                this.sidemenu.select(this.items[0].path, this.items[0].children);
            }
        });
    }
    search(term) {
        let results = this.items;
        // if no prepared searchable data is available we just return everything
        if (this.preparedSearchableItems) {
            // now we process the searching of the data
            results = this.preparedSearchableItems(term);
        }
        if (!term || term === '') {
            results = [];
        }
        // return observable of results using same type has this.item
        return of(results);
    }
    ngOnDestroy() {
        this._intlChanges.unsubscribe();
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String),
    tslib_1.__metadata("design:paramtypes", [String])
], RufMegamenuComponent.prototype, "searchPlaceholder", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String),
    tslib_1.__metadata("design:paramtypes", [String])
], RufMegamenuComponent.prototype, "clearSearchAriaLabel", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Array)
], RufMegamenuComponent.prototype, "items", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], RufMegamenuComponent.prototype, "select", void 0);
tslib_1.__decorate([
    ViewChild('sidemenu', { static: true }),
    tslib_1.__metadata("design:type", RufSidemenuComponent)
], RufMegamenuComponent.prototype, "sidemenu", void 0);
RufMegamenuComponent = tslib_1.__decorate([
    Component({
        selector: 'ruf-megamenu',
        template: "<div class=\"ruf-sidemenu-container\">\n  <ruf-megamenu-search (filterValue)=\"searchTerms$.next($event)\" (inputFocus)=\"selectedSidemenuItems$.next()\" [placeholder]=\"searchPlaceholder\" [clearSearchLabel]=\"clearSearchAriaLabel\"></ruf-megamenu-search>\n  <ruf-sidemenu #sidemenu [selectedPath]=\"(selectedSidemenuItems$ | async)?.path\" (select)=\"selectedSidemenuItems$.next($event);\">\n    <ruf-sidemenu-item *ngFor=\"let item of items\" [path]=\"item.path\" [data]=\"item.children\">{{item.label}}</ruf-sidemenu-item>\n  </ruf-sidemenu>\n</div>\n<div class=\"ruf-sitemap-container\">\n  <ruf-sitemap [items]=\"sitemapItems$\" (select)=\"select.emit($event)\">\n  </ruf-sitemap>\n</div>\n",
        encapsulation: ViewEncapsulation.None,
        changeDetection: ChangeDetectionStrategy.OnPush,
        providers: [RufSearchService],
        styles: ["ruf-megamenu{display:-webkit-box;display:flex;flex-shrink:0;overflow-x:auto;padding:20px 20px 20px 0;width:100%}ruf-megamenu .ruf-sidemenu-container{height:100%;max-width:200px;min-width:200px;overflow-x:hidden;overflow-y:auto}ruf-megamenu .ruf-sidemenu-container ruf-sidemenu{flex-shrink:0;min-width:200px}ruf-megamenu .fis-search-input-container,ruf-megamenu .ruf-focus{border-left-style:solid;border-left-width:2px}ruf-megamenu .ruf-sitemap-container{border-style:solid;border-width:20px;display:-webkit-box;display:flex;-webkit-box-flex:1;flex:1 1 auto}ruf-megamenu .ruf-sidemenu-container::-webkit-scrollbar{width:.5em}ruf-megamenu ruf-sitemap{padding:18px}ruf-megamenu::-webkit-scrollbar{height:.5em}"]
    }),
    tslib_1.__metadata("design:paramtypes", [RufSearchService, RufShellIntl, ChangeDetectorRef])
], RufMegamenuComponent);
export { RufMegamenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVnYW1lbnUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ1Zi9zaGVsbC8iLCJzb3VyY2VzIjpbInNyYy9tZWdhbWVudS9tZWdhbWVudS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXpELE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLGlCQUFpQixFQUlqQixTQUFTLEVBQ1QsdUJBQXVCLEVBR3hCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBa0IsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUNMLFlBQVksRUFDWixvQkFBb0IsRUFDcEIsR0FBRyxFQUNILFNBQVMsRUFDVCxTQUFTLEVBQ1QsY0FBYyxFQUNmLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBVW5ELElBQWEsb0JBQW9CLEdBQWpDLE1BQWEsb0JBQW9CO0lBbUMvQixZQUFxQixhQUErQixFQUFVLEtBQW1CLEVBQUUsaUJBQW9DO1FBQWxHLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQUFVLFVBQUssR0FBTCxLQUFLLENBQWM7UUFmeEUsVUFBSyxHQUFvQixFQUFFLENBQUM7UUFDM0IsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFpQixDQUFDO1FBSXJELDZDQUE2QztRQUM3Qyw0QkFBNEI7UUFDNUIsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDLENBQUMseUJBQXlCO1FBQy9ELCtCQUErQjtRQUMvQiwyQkFBc0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDLENBQUMsc0RBQXNEO1FBSTNGLDRC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QyxDQUFDO1NBQzlDO1FBQ0QsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLEtBQUssRUFBRSxFQUFFO1lBQ3hCLE9BQU8sR0FBRyxFQUFFLENBQUM7U0FDZDtRQUNELDZEQUE2RDtRQUM3RCxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRUEsV0FBVztRQUNWLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbEMsQ0FBQztDQUNGLENBQUE7QUE5RkM7SUFEQyxLQUFLLEVBQUU7Ozs2REFHUDtBQU1EO0lBREMsS0FBSyxFQUFFOzs7Z0VBR1A7QUFLUTtJQUFSLEtBQUssRUFBRTs7bURBQTZCO0FBQzNCO0lBQVQsTUFBTSxFQUFFOztvREFBNEM7QUFFZDtJQUF0QyxTQUFTLENBQUMsVUFBVSxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDO3NDQUFXLG9CQUFvQjtzREFBQztBQXZCM0Qsb0JBQW9CO0lBUmhDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxjQUFjO1FBQ3hCLG9zQkFBd0M7UUFFeEMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7UUFDckMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07UUFDL0MsU0FBUyxFQUFFLENBQUMsZ0JBQWdCLENBQUM7O0tBQzlCLENBQUM7NkNBb0NvQyxnQkFBZ0IsRUFBaUIsWUFBWSxFQUFxQixpQkFBaUI7R0FuQzVHLG9CQUFvQixDQW1HaEM7U0FuR1ksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUnVmU2lkZW1lbnVDb21wb25lbnQgfSBmcm9tICcuLy4uL3NpZGVtZW51L3NpZGVtZW51LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBSdWZTZWFyY2hTZXJ2aWNlIH0gZnJvbSAnLi9tZW51LXNlYXJjaC5zZXJ2aWNlJztcbmltcG9ydCB7IFJ1ZlNlYXJjaEl0ZW0gfSBmcm9tICcuL3NlYXJjaC9zZWFyY2hpdGVtLmludGVyZmFjZSc7XG5pbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBPbkluaXQsXG4gIE9uRGVzdHJveSxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgVmlld0NoaWxkLFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgT25DaGFuZ2VzLFxuICBTaW1wbGVDaGFuZ2VzXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgbWVyZ2UsIG9mICwgIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZGVib3VuY2VUaW1lLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgbWFwLFxuICBzdGFydFdpdGgsXG4gIHN3aXRjaE1hcCxcbiAgd2l0aExhdGVzdEZyb21cbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUnVmU2hlbGxJbnRsIH0gZnJvbSAnLi4vdXRpbHMvc2hlbGwtaW50bCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3J1Zi1tZWdhbWVudScsXG4gIHRlbXBsYXRlVXJsOiAnLi9tZWdhbWVudS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL21lZ2FtZW51LmNvbXBvbmVudC5zY3NzJ10sXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBwcm92aWRlcnM6IFtSdWZTZWFyY2hTZXJ2aWNlXVxufSlcbmV4cG9ydCBjbGFzcyBSdWZNZWdhbWVudUNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIF9pbnRsQ2hhbmdlczogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIF9zZWFyY2hQbGFjZWhvbGRlcjogc3RyaW5nO1xuICBwcml2YXRlIF9jbGVhclNlYXJjaEFyaWFMYWJlbDogc3RyaW5nO1xuICBASW5wdXQoKVxuICBnZXQgc2VhcmNoUGxhY2Vob2xkZXIoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NlYXJjaFBsYWNlaG9sZGVyIHx8IHRoaXMuX2ludGwubWVnYW1lbnUucGxhY2Vob2xkZXI7XG4gIH1cbiAgc2V0IHNlYXJjaFBsYWNlaG9sZGVyKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9zZWFyY2hQbGFjZWhvbGRlciA9IHZhbHVlO1xuICB9XG5cbiAgQElucHV0KClcbiAgZ2V0IGNsZWFyU2VhcmNoQXJpYUxhYmVsKCkge1xuICAgIHJldHVybiB0aGlzLl9jbGVhclNlYXJjaEFyaWFMYWJlbCB8fCB0aGlzLl9pbnRsLm1lZ2FtZW51LmFyaWEuY2xlYXJTZWFyY2hMYWJlbDtcbiAgfVxuICBzZXQgY2xlYXJTZWFyY2hBcmlhTGFiZWwodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMuX2NsZWFyU2VhcmNoQXJpYUxhYmVsID0gdmFsdWU7XG4gIH1cblxuICBASW5wdXQoKSBpdGVtczogUnVmU2VhcmNoSXRlbVtdID0gW107XG4gIEBPdXRwdXQoKSBzZWxlY3QgPSBuZXcgRXZlbnRFbWl0dGVyPFJ1ZlNlYXJjaEl0ZW0+KCk7XG5cbiAgQFZpZXdDaGlsZCgnc2lkZW1lbnUnLCB7c3RhdGljOiB0cnVlfSkgc2lkZW1lbnU6IFJ1ZlNpZGVtZW51Q29tcG9uZW50O1xuXG4gIC8vIFN1YmplY3RzOiBkZW5vdGVzIHVzZXIgaW50ZXJhY3Rpb24gc3RyZWFtc1xuICAvLyBzZWFyY2ggcmVsYXRlZCBwcm9wZXJ0aWVzXG4gIHNlYXJjaFRlcm1zJCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTsgLy8gc3RyZWFtIG9mIHNlYXJjaCB0ZXJtc1xuICAvLyBzaWRlbWVudSBzZWxlY3QgZXZlbnQgc3RyZWFtXG4gIHNlbGVjdGVkU2lkZW1lbnVJdGVtcyQgPSBuZXcgU3ViamVjdDxhbnk+KCk7IC8vIHN0cmVhbSBvZiBzZWxlY3RlZCBpdGVtcyAoc2FtZSB0eXBlIGhhcyB0aGlzLml0ZW1zKVxuICAvLyBtZXJnZSBzZWFyY2ggcmVzdWx0cyBhbmQgc2VsZWN0ZWQgbWVudSBpdGVtJ3MgY2hpbGRyZW4gaW50byBhIHNpbmdsZSBzdHJlYW1cbiAgc2l0ZW1hcEl0ZW1zJDogT2JzZXJ2YWJsZTxSdWZTZWFyY2hJdGVtW10+OyAvLyB1c2Ugc2FtZSB0eXBlIGhhcyB0aGlzLml0ZW1zXG5cbiAgcHJpdmF0ZSBwcmVwYXJlZFNlYXJjaGFibGVJdGVtczogKHRlcm06IHN0cmluZykgPT4gUnVmU2VhcmNoSXRlbVtdID0gKHRlcm0pID0+IFtdO1xuXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHNlYXJjaFNlcnZpY2U6IFJ1ZlNlYXJjaFNlcnZpY2UsIHByaXZhdGUgX2ludGw6IFJ1ZlNoZWxsSW50bCwgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmKSB7XG4gICAgdGhpcy5faW50bENoYW5nZXMgPSBfaW50bC5jaGFuZ2VzLnN1YnNjcmliZSgoKSA9PiBjaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICAvLyBtYXAgc2VhcmNoIHRlcm1zIHRvIGEgc2VhcmNoIHJlc3VsdHMgc3RyZWFtIHJlYWR5IHRvIGJlIGNvbnN1bWVkIGJ5IHNpdGVtYXBcbiAgICBjb25zdCBzZWFyY2hSZXN1bHRzJCA9IHRoaXMuc2VhcmNoVGVybXMkLnBpcGUoXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgZGVib3VuY2VUaW1lKDQwMCksIC8vIGRvbid0IHNlYXJjaCB1bmxlc3MgdXNlciBzdG9wcGVkIHR5cGluZyBmb3IgNDAwbXNcbiAgICAgIHN3aXRjaE1hcCh0ZXJtID0+IHRoaXMuc2VhcmNoKHRlcm0pKSwgLy8gaWdub3JlIGFscmVhZHkgdHJpZ2dlcmVkIHNlYXJjaGVzLlxuICAgICAgc3RhcnRXaXRoKFtdKVxuICAgICAgKTsgLy8gc3RhcnQgd2l0aCBlbXB0eSByZXN1bHRzXG5cbiAgICAvLyBtYXAgc2lkZW1lbnUgc2VsZWN0IGV2ZW50IHRvIHNlbGVjdGVkIGl0ZW0ncyBjaGlsZHJlbiBhcnJheVxuICAgIGNvbnN0IHNlbGVjdGVkSXRlbUNoaWxkcmVuJCA9IHRoaXMuc2VsZWN0ZWRTaWRlbWVudUl0ZW1zJC5waXBlKFxuICAgICAgd2l0aExhdGVzdEZyb20oc2VhcmNoUmVzdWx0cyQpLCAvLyBjb21iaW5lIGVhY2ggZXZlbnQgd2l0aCB0aGUgbGF0ZXN0IG9mIHRoZSBzZWFyY2hSZXN1bHRzJCBzdHJlYW1cbiAgICAgIG1hcCgoW2l0ZW0sIHNlYXJjaFJlc3VsdHNdKSA9PiB7XG4gICAgICAgIGlmICghaXRlbSkge1xuICAgICAgICAgIHJldHVybiBzZWFyY2hSZXN1bHRzIHx8IFtdO1xuICAgICAgICB9XG4gICAgICAgIC8vIG1hcCB0byB0aGUgc2VsZWN0ZWQgaXRlbSdzIGNoaWxkcmVuIG9yIGFuIGVtcHR5IGFycmF5LlxuICAgICAgICByZXR1cm4gaXRlbS5kYXRhIHx8IFtdO1xuICAgICAgfSkpO1xuXG4gICAgLy8gc2l0ZW1hcCBkYXRhIHN0cmVhbSBpcyBhIG1lcmdlIG9mIHNlYXJjaCByZXN1bHRzIGFuZCBzZWxlY3RlZCBpdGVtJ3MgY2hpbGRyZW4gc3RyZWFtc1xuICAgIHRoaXMuc2l0ZW1hcEl0ZW1zJCA9IG1lcmdlKFxuICAgICAgc2VsZWN0ZWRJdGVtQ2hpbGRyZW4kLFxuICAgICAgc2VhcmNoUmVzdWx0cyRcbiAgICApO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIC8vIHdoZW4gYW55IGNoYW5nZXMgdG8gdGhlIGl0ZW1zIG9jY3VyLCByZS1wcmVwYXJlIHRoZSBzZWFyY2hcbiAgICBpZiAoY2hhbmdlcy5pdGVtcyAmJiBjaGFuZ2VzLml0ZW1zLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgdGhpcy5wcmVwYXJlZFNlYXJjaGFibGVJdGVtcyA9IHRoaXMuc2VhcmNoU2VydmljZS5wcmVwYXJlU2VhcmNoKGNoYW5nZXMuaXRlbXMuY3VycmVudFZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgLy8gb25jZSB0aGUgc2lkZW1lbnUgaXMgY3JlYXRlZCAoYWZ0ZXIgdmlldyBpbml0KSwgc2VsZWN0IGZpcnN0IHNpZGVtZW51IGl0ZW1cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGlmICh0aGlzLml0ZW1zWzBdKSB7XG4gICAgICAgIHRoaXMuc2lkZW1lbnUuc2VsZWN0KHRoaXMuaXRlbXNbMF0ucGF0aCwgdGhpcy5pdGVtc1swXS5jaGlsZHJlbik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNlYXJjaCh0ZXJtOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFJ1ZlNlYXJjaEl0ZW1bXT4ge1xuICAgIGxldCByZXN1bHRzID0gdGhpcy5pdGVtcztcbiAgICAvLyBpZiBubyBwcmVwYXJlZCBzZWFyY2hhYmxlIGRhdGEgaXMgYXZhaWxhYmxlIHdlIGp1c3QgcmV0dXJuIGV2ZXJ5dGhpbmdcbiAgICBpZiAodGhpcy5wcmVwYXJlZFNlYXJjaGFibGVJdGVtcykge1xuICAgICAgLy8gbm93IHdlIHByb2Nlc3MgdGhlIHNlYXJjaGluZyBvZiB0aGUgZGF0YVxuICAgICAgcmVzdWx0cyA9IHRoaXMucHJlcGFyZWRTZWFyY2hhYmxlSXRlbXModGVybSk7XG4gICAgfVxuICAgIGlmICghdGVybSB8fCB0ZXJtID09PSAnJykge1xuICAgICAgcmVzdWx0cyA9IFtdO1xuICAgIH1cbiAgICAvLyByZXR1cm4gb2JzZXJ2YWJsZSBvZiByZXN1bHRzIHVzaW5nIHNhbWUgdHlwZSBoYXMgdGhpcy5pdGVtXG4gICAgcmV0dXJuIG9mKHJlc3VsdHMpO1xuICB9XG5cbiAgIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX2ludGxDaGFuZ2VzLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==