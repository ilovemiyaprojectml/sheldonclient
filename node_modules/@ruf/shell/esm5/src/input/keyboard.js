/**The MIT License

Copyright (c) 2017 Google, Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
import { FocusKeyManager, ListKeyManager } from '@angular/cdk/a11y';
// Focusable interface renamed to FocusableOption in @angular/cdk beta-10.
import { Subject } from 'rxjs';
import { HOME, END } from '@angular/cdk/keycodes';
var RufKeyCodes = /** @class */ (function () {
    function RufKeyCodes() {
    }
    RufKeyCodes.ENTER = 13;
    RufKeyCodes.ESCAPE = 27;
    RufKeyCodes.SPACE = 32;
    RufKeyCodes.LEFT_ARROW = 37;
    RufKeyCodes.UP_ARROW = 38;
    RufKeyCodes.RIGHT_ARROW = 39;
    RufKeyCodes.DOWN_ARROW = 40;
    return RufKeyCodes;
}());
export { RufKeyCodes };
var RufKeyboardNavigation = /** @class */ (function () {
    function RufKeyboardNavigation() {
        this._direction = 'row';
    }
    // To receive select notifications, subscribe to this function
    RufKeyboardNavigation.prototype.init = function (container, items) {
        this._container = container;
        this._items = items;
        this._FocusKeyManager = new FocusKeyManager(items).withWrap();
        this._ListKeyManager = new ListKeyManager(items);
        if (items.length > 0) {
            this.setActiveItemWithoutFocus(0);
            this._ListKeyManager.setActiveItem.call(this._FocusKeyManager, 0);
        }
        this._subscription = new Subject();
        return this._subscription;
    };
    RufKeyboardNavigation.prototype.setActiveItem = function (index) {
        this._FocusKeyManager.setActiveItem(index);
    };
    RufKeyboardNavigation.prototype.setActiveItemWithoutFocus = function (index) {
        this._ListKeyManager.setActiveItem.call(this._FocusKeyManager, index);
    };
    RufKeyboardNavigation.prototype.navigate = function (event) {
        switch (event.keyCode) {
            case RufKeyCodes.ESCAPE:
                this._container.nativeElement.focus();
                break;
            case RufKeyCodes.LEFT_ARROW:
            case RufKeyCodes.UP_ARROW:
                this._FocusKeyManager.setPreviousItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case RufKeyCodes.RIGHT_ARROW:
            case RufKeyCodes.DOWN_ARROW:
                this._FocusKeyManager.setNextItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case RufKeyCodes.SPACE:
            case RufKeyCodes.ENTER:
                this.selectFocusedItem();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case HOME:
                this._FocusKeyManager.setFirstItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            case END:
                this._FocusKeyManager.setLastItemActive();
                // prevent scrollbar catching the event
                this.preventEventPropagation(event);
                break;
            default:
                this._FocusKeyManager.onKeydown(event);
                break;
        }
    };
    RufKeyboardNavigation.prototype.preventEventPropagation = function (event) {
        event.preventDefault();
        event.stopPropagation();
    };
    RufKeyboardNavigation.prototype.onKeyDown = function (event) {
        if (this._items.length === 0) {
            return;
        }
        this.navigate(event);
    };
    RufKeyboardNavigation.prototype.addTabIndex = function (focusableItems) {
        focusableItems.forEach(function (child, index) {
            if (index === 0) {
                child._elementRef.nativeElement.setAttribute('tabindex', 0);
            }
            else {
                child._elementRef.nativeElement.setAttribute('tabindex', -1);
            }
        });
    };
    RufKeyboardNavigation.prototype.selectFocusedItem = function () {
        if (this._FocusKeyManager.activeItem) {
            this._subscription.next(this._FocusKeyManager.activeItem);
        }
    };
    RufKeyboardNavigation.prototype.focus = function (path) {
        if (!this._items || this._items.length === 0) {
            return;
        }
        var item = this._items.find(function (f) { return f.path === path; });
        var index = this._items.toArray().indexOf(item);
        this._FocusKeyManager.setActiveItem(index);
    };
    RufKeyboardNavigation.prototype.isActive = function () {
        return this._FocusKeyManager.activeItem !== undefined;
    };
    RufKeyboardNavigation.prototype.setDirection = function (direction) {
        if (direction === 'column') {
            this._direction = direction;
        }
    };
    return RufKeyboardNavigation;
}());
export { RufKeyboardNavigation };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5Ym9hcmQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcnVmL3NoZWxsLyIsInNvdXJjZXMiOlsic3JjL2lucHV0L2tleWJvYXJkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7RUFxQkU7QUFHRixPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBbUIsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRiwwRUFBMEU7QUFDMUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQXVFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUV2SDtJQUFBO0lBUUEsQ0FBQztJQVBpQixpQkFBSyxHQUFHLEVBQUUsQ0FBQztJQUNYLGtCQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ1osaUJBQUssR0FBRyxFQUFFLENBQUM7SUFDWCxzQkFBVSxHQUFHLEVBQUUsQ0FBQztJQUNoQixvQkFBUSxHQUFHLEVBQUUsQ0FBQztJQUNkLHVCQUFXLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLHNCQUFVLEdBQUcsRUFBRSxDQUFDO0lBQ2xDLGtCQUFDO0NBQUEsQUFSRCxJQVFDO1NBUlksV0FBVztBQVV4QjtJQUFBO1FBTVUsZUFBVSxHQUFHLEtBQUssQ0FBQztJQTRHN0IsQ0FBQztJQTFHQyw4REFBOEQ7SUFDOUQsb0NBQUksR0FBSixVQUFLLFNBQXFCLEVBQUUsS0FBcUI7UUFDL0MsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakQsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFB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Q0gsNEJBQUM7QUFBRCxDQUFDLEFBbEhELElBa0hDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqVGhlIE1JVCBMaWNlbnNlXG5cbkNvcHlyaWdodCAoYykgMjAxNyBHb29nbGUsIEluYy5cblxuUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxub2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xudG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG5mdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuXG5UaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG5cblRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbklNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG5BVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG5MSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuVEhFIFNPRlRXQVJFLlxuKi9cblxuaW1wb3J0IHsgUXVlcnlMaXN0LCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb2N1c0tleU1hbmFnZXIsIExpc3RLZXlNYW5hZ2VyLCBGb2N1c2FibGVPcHRpb24gfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG4vLyBGb2N1c2FibGUgaW50ZXJmYWNlIHJlbmFtZWQgdG8gRm9jdXNhYmxlT3B0aW9uIGluIEBhbmd1bGFyL2NkayBiZXRhLTEwLlxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTEVGVF9BUlJPVywgUklHSFRfQVJST1csIERPV05fQVJST1csIFVQX0FSUk9XLCBFTlRFUiwgU1BBQ0UsIEVTQ0FQRSwgSE9NRSwgRU5EIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2tleWNvZGVzJztcblxuZXhwb3J0IGNsYXNzIFJ1ZktleUNvZGVzIHtcbiAgc3RhdGljIHJlYWRvbmx5IEVOVEVSID0gMTM7XG4gIHN0YXRpYyByZWFkb25seSBFU0NBUEUgPSAyNztcbiAgc3RhdGljIHJlYWRvbmx5IFNQQUNFID0gMzI7XG4gIHN0YXRpYyByZWFkb25seSBMRUZUX0FSUk9XID0gMzc7XG4gIHN0YXRpYyByZWFkb25seSBVUF9BUlJPVyA9IDM4O1xuICBzdGF0aWMgcmVhZG9ubHkgUklHSFRfQVJST1cgPSAzOTtcbiAgc3RhdGljIHJlYWRvbmx5IERPV05fQVJST1cgPSA0MDtcbn1cblxuZXhwb3J0IGNsYXNzIFJ1ZktleWJvYXJkTmF2aWdhdGlvbiB7XG4gIHByaXZhdGUgX0ZvY3VzS2V5TWFuYWdlcjogRm9jdXNLZXlNYW5hZ2VyPEZvY3VzYWJsZU9wdGlvbj47XG4gIHByaXZhdGUgX0xpc3RLZXlNYW5hZ2VyOiBMaXN0S2V5TWFuYWdlcjxGb2N1c2FibGVPcHRpb24+O1xuICBwcml2YXRlIF9zdWJzY3JpcHRpb246IFN1YmplY3Q8YW55PjtcbiAgcHJpdmF0ZSBfY29udGFpbmVyOiBFbGVtZW50UmVmO1xuICBwcml2YXRlIF9pdGVtczogUXVlcnlMaXN0PGFueT47XG4gIHByaXZhdGUgX2RpcmVjdGlvbiA9ICdyb3cnO1xuXG4gIC8vIFRvIHJlY2VpdmUgc2VsZWN0IG5vdGlmaWNhdGlvbnMsIHN1YnNjcmliZSB0byB0aGlzIGZ1bmN0aW9uXG4gIGluaXQoY29udGFpbmVyOiBFbGVtZW50UmVmLCBpdGVtczogUXVlcnlMaXN0PGFueT4pOiBTdWJqZWN0PGFueT4ge1xuICAgIHRoaXMuX2NvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICB0aGlzLl9pdGVtcyA9IGl0ZW1zO1xuICAgIHRoaXMuX0ZvY3VzS2V5TWFuYWdlciA9IG5ldyBGb2N1c0tleU1hbmFnZXIoaXRlbXMpLndpdGhXcmFwKCk7XG4gICAgdGhpcy5fTGlzdEtleU1hbmFnZXIgPSBuZXcgTGlzdEtleU1hbmFnZXIoaXRlbXMpO1xuICAgIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnNldEFjdGl2ZUl0ZW1XaXRob3V0Rm9jdXMoMCk7XG4gICAgICB0aGlzLl9MaXN0S2V5TWFuYWdlci5zZXRBY3RpdmVJdGVtLmNhbGwodGhpcy5fRm9jdXNLZXlNYW5hZ2VyLCAwKTtcbiAgICB9XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpcHRpb247XG4gIH1cblxuICBzZXRBY3RpdmVJdGVtKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0QWN0aXZlSXRlbShpbmRleCk7XG4gIH1cblxuICBzZXRBY3RpdmVJdGVtV2l0aG91dEZvY3VzKGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLl9MaXN0S2V5TWFuYWdlci5zZXRBY3RpdmVJdGVtLmNhbGwodGhpcy5fRm9jdXNLZXlNYW5hZ2VyLCBpbmRleCk7XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgc3dpdGNoIChldmVudC5rZXlDb2RlKSB7XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLkVTQ0FQRTpcbiAgICAgICAgdGhpcy5fY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLkxFRlRfQVJST1c6XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLlVQX0FSUk9XOlxuICAgICAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0UHJldmlvdXNJdGVtQWN0aXZlKCk7XG4gICAgICAgIC8vIHByZXZlbnQgc2Nyb2xsYmFyIGNhdGNoaW5nIHRoZSBldmVudFxuICAgICAgICB0aGlzLnByZXZlbnRFdmVudFByb3BhZ2F0aW9uKGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLlJJR0hUX0FSUk9XOlxuICAgICAgY2FzZSBSdWZLZXlDb2Rlcy5ET1dOX0FSUk9XOlxuICAgICAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0TmV4dEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgY2F0Y2hpbmcgdGhlIGV2ZW50XG4gICAgICAgIHRoaXMucHJldmVudEV2ZW50UHJvcGFnYXRpb24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUnVmS2V5Q29kZXMuU1BBQ0U6XG4gICAgICBjYXNlIFJ1ZktleUNvZGVzLkVOVEVSOlxuICAgICAgICB0aGlzLnNlbGVjdEZvY3VzZWRJdGVtKCk7XG4gICAgICAgIC8vIHByZXZlbnQgc2Nyb2xsYmFyIGNhdGNoaW5nIHRoZSBldmVudFxuICAgICAgICB0aGlzLnByZXZlbnRFdmVudFByb3BhZ2F0aW9uKGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEhPTUU6XG4gICAgICAgIHRoaXMuX0ZvY3VzS2V5TWFuYWdlci5zZXRGaXJzdEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgY2F0Y2hpbmcgdGhlIGV2ZW50XG4gICAgICAgIHRoaXMucHJldmVudEV2ZW50UHJvcGFnYXRpb24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRU5EOlxuICAgICAgICB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuc2V0TGFzdEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgY2F0Y2hpbmcgdGhlIGV2ZW50XG4gICAgICAgIHRoaXMucHJldmVudEV2ZW50UHJvcGFnYXRpb24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuX0ZvY3VzS2V5TWFuYWdlci5vbktleWRvd24oZXZlbnQpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHByZXZlbnRFdmVudFByb3BhZ2F0aW9uKGV2ZW50KSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgfVxuXG4gIG9uS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm5hdmlnYXRlKGV2ZW50KTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRUYWJJbmRleChmb2N1c2FibGVJdGVtcykge1xuICAgIGZvY3VzYWJsZUl0ZW1zLmZvckVhY2goKGNoaWxkLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgIGNoaWxkLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsIDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2hpbGQuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywgLTEpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RGb2N1c2VkSXRlbSgpIHtcbiAgICBpZiAodGhpcy5fRm9jdXNLZXlNYW5hZ2VyLmFjdGl2ZUl0ZW0pIHtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbi5uZXh0KHRoaXMuX0ZvY3VzS2V5TWFuYWdlci5hY3RpdmVJdGVtKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZm9jdXMocGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLl9pdGVtcyB8fCB0aGlzLl9pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuX2l0ZW1zLmZpbmQoZiA9PiBmLnBhdGggPT09IHBhdGgpO1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5faXRlbXMudG9BcnJheSgpLmluZGV4T2YoaXRlbSk7XG4gICAgdGhpcy5fRm9jdXNLZXlNYW5hZ2VyLnNldEFjdGl2ZUl0ZW0oaW5kZXgpO1xuICB9XG5cbiAgcHVibGljIGlzQWN0aXZlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9Gb2N1c0tleU1hbmFnZXIuYWN0aXZlSXRlbSAhPT0gdW5kZWZpbmVkO1xuICB9XG4gIHB1YmxpYyBzZXREaXJlY3Rpb24oZGlyZWN0aW9uOiBzdHJpbmcpIHtcbiAgICBpZiAoZGlyZWN0aW9uID09PSAnY29sdW1uJykge1xuICAgICAgdGhpcy5fZGlyZWN0aW9uID0gZGlyZWN0aW9uO1xuICAgIH1cbiAgfVxufVxuIl19