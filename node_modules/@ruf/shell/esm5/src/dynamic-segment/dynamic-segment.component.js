import * as tslib_1 from "tslib";
import { Component, ContentChild, TemplateRef, ViewEncapsulation, ChangeDetectionStrategy, EventEmitter, Input, Output, ElementRef, ViewChildren, QueryList, HostListener } from '@angular/core';
import { MatButtonToggle } from '@angular/material/button-toggle';
import { RufKeyboardNavigation } from '../input/keyboard';
var RufDynamicSegmentComponent = /** @class */ (function () {
    function RufDynamicSegmentComponent(_elementRef) {
        this._elementRef = _elementRef;
        this.items = [];
        /* tslint:disable:no-output-rename */
        // Renaming output to avoid duplicate `select` identifiers
        this.selectEmitter = new EventEmitter();
    }
    Object.defineProperty(RufDynamicSegmentComponent.prototype, "selectedPath", {
        get: function () {
            return this._selectedPath;
        },
        set: function (id) {
            this._selectedPath = id;
        },
        enumerable: true,
        configurable: true
    });
    RufDynamicSegmentComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.addNewKeyboardNav();
        this.segmentItems.changes.subscribe(function () {
            _this.addNewKeyboardNav();
        });
    };
    RufDynamicSegmentComponent.prototype.onKey = function (event) {
        this._keyboardNav.onKeyDown(event);
    };
    RufDynamicSegmentComponent.prototype.ngOnChanges = function (changes) {
        if (changes.selectedPath && changes.selectedPath.currentValue) {
            this.selectSegmentItem({ path: changes.selectedPath.currentValue });
        }
    };
    RufDynamicSegmentComponent.prototype.ngOnDestroy = function () {
        this.subscription.unsubscribe();
    };
    // Set Keyboard navigation
    RufDynamicSegmentComponent.prototype.addNewKeyboardNav = function () {
        var _this = this;
        this._keyboardNav = new RufKeyboardNavigation();
        this.subscription = this._keyboardNav.init(this._elementRef, this.segmentItems).subscribe(function (item) {
            _this.selectSegmentItem({ path: item.value });
        });
        this._keyboardNav.addTabIndex(this.segmentItems);
    };
    /**
     * Set selectedPath and activate dynamic-segment item
     * @param item
     */
    RufDynamicSegmentComponent.prototype.selectSegmentItem = function (item) {
        this._selectedPath = item.path;
        var selectedIndex = this.selectedIndex();
        if (this._keyboardNav) {
            this._keyboardNav.setActiveItem((selectedIndex === -1) ? 0 : selectedIndex);
        }
        if (this.segmentItems) {
            // if segmentItems are not present, the component view is not loaded yet.
            // This means 'selectSegmentItem' is called from 'ngOnChanges' and the host element has [selectedPath] input.
            var selectedItem = (selectedIndex === -1) ? null : this.items[selectedIndex];
            this.selectEmitter.emit(selectedItem);
        }
    };
    /**
     * @returns - index of the selected dynamic-segment item. -1 if no dynamic-segment is selected.
     */
    RufDynamicSegmentComponent.prototype.selectedIndex = function () {
        var _this = this;
        var index = -1;
        if (this.segmentItems) {
            index = this.items.findIndex(function (segmentItem, i) { return _this._matches(segmentItem.path); });
        }
        return index;
    };
    RufDynamicSegmentComponent.prototype._matches = function (path) {
        if (path && this.selectedPath) {
            var pattern = new RegExp('^((\/)?' + this.selectedPath + ')(\/.*)?$'); // use word boundary to exact match
            if (path === this.selectedPath || pattern.test(path)) { // match with and parent dynamic-segment item
                return true;
            }
        }
        return false;
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], RufDynamicSegmentComponent.prototype, "items", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], RufDynamicSegmentComponent.prototype, "showActiveItemClip", void 0);
    tslib_1.__decorate([
        Output('select'),
        tslib_1.__metadata("design:type", Object)
    ], RufDynamicSegmentComponent.prototype, "selectEmitter", void 0);
    tslib_1.__decorate([
        ViewChildren(MatButtonToggle),
        tslib_1.__metadata("design:type", QueryList)
    ], RufDynamicSegmentComponent.prototype, "segmentItems", void 0);
    tslib_1.__decorate([
        ContentChild(TemplateRef, { static: false }),
        tslib_1.__metadata("design:type", Object)
    ], RufDynamicSegmentComponent.prototype, "navActions", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String),
        tslib_1.__metadata("design:paramtypes", [String])
    ], RufDynamicSegmentComponent.prototype, "selectedPath", null);
    tslib_1.__decorate([
        HostListener('keydown', ['$event']),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [KeyboardEvent]),
        tslib_1.__metadata("design:returntype", void 0)
    ], RufDynamicSegmentComponent.prototype, "onKey", null);
    RufDynamicSegmentComponent = tslib_1.__decorate([
        Component({
            selector: 'ruf-dynamic-segment',
            template: "<div class=\"segment-layout\" role=\"menubar\">\n  <mat-button-toggle-group rufId=\"segmentGroup\" fisStyle class=\"segment-group\" value=\"{{selectedPath}}\">\n    <mat-button-toggle rufId class=\"segment-item\"\n                       [class.mat-button-toggle-selected]=\"selectedPath === item.path ? true : false\"\n                       [class.mat-button-toggle-checked]=\"selectedPath === item.path ? true : false\"\n                       [class.segment-clip]=\"showActiveItemClip\"\n                       fisStyle\n                       *ngFor=\"let item of items\"\n                       (click)=\"selectSegmentItem(item)\"\n                       value=\"{{item.path}}\"\n                       title=\"{{item.tooltipText}}\"\n                       role=\"menuitem\">\n      {{item.label}}\n      <ng-template [ngTemplateOutlet]=\"navActions\" [ngTemplateOutletContext]=\"{item: item}\">\n      </ng-template>\n    </mat-button-toggle>\n  </mat-button-toggle-group>\n</div>\n",
            encapsulation: ViewEncapsulation.None,
            changeDetection: ChangeDetectionStrategy.OnPush,
            styles: [".segment-layout{-webkit-box-align:stretch;align-items:stretch;display:-webkit-box;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.segment-layout .mat-button-toggle-group{overflow:visible}.segment-item:focus{outline:0}.segment-item>label{cursor:pointer;text-align:center;width:100%}.segment-group>.segment-item{-webkit-box-align:center;align-items:center;border-bottom-style:solid;border-bottom-width:.125rem;border-color:transparent;border-top-style:solid;border-top-width:.125rem;cursor:pointer;display:-webkit-box;display:flex;-webkit-box-flex:1;flex:1 auto;-webkit-box-pack:center;justify-content:center;padding:0;-webkit-transition:background-color .2s;transition:background-color .2s}.segment-group>.segment-clip::after{border-left:10px solid transparent;border-right:10px solid transparent;border-top:15px solid transparent;content:'';left:calc(50% - 10px);position:absolute;top:100%}"]
        }),
        tslib_1.__metadata("design:paramtypes", [ElementRef])
    ], RufDynamicSegmentComponent);
    return RufDynamicSegmentComponent;
}());
export { RufDynamicSegmentComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1zZWdtZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BydWYvc2hlbGwvIiwic291cmNlcyI6WyJzcmMvZHluYW1pYy1zZWdtZW50L2R5bmFtaWMtc2VnbWVudC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLFdBQVcsRUFDWCxpQkFBaUIsRUFDakIsdUJBQXVCLEVBQ3ZCLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUVOLFVBQVUsRUFJVixZQUFZLEVBQ1osU0FBUyxFQUNULFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFHbEUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFTMUQ7SUF3QkUsb0NBQXNCLFdBQXVCO1FBQXZCLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBbEJwQyxVQUFLLEdBQTRCLEVBQUUsQ0FBQztRQUU3QyxxQ0FBcUM7UUFDckMsMERBQTBEO1FBQ3hDLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQXlCLENBQUM7SUFjM0IsQ0FBQztJQVJsRCxzQkFBSSxvREFBWTthQUloQjtZQUNFLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUM1QixDQUFDO2FBTkQsVUFBaUIsRUFBVTtZQUN6QixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUMxQixDQUFDOzs7T0FBQTtJQVFELG9EQUFlLEdBQWY7UUFBQSxpQkFLQztRQUpDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUNsQyxLQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFHRCwwQ0FBSyxHQUFMLFVBQU0sS0FBb0I7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O0lBQ2YsQ0FBQztJQXpGUTtRQUFSLEtBQUssRUFBRTs7NkRBQXFDO0lBQ3BDO1FBQVIsS0FBSyxFQUFFOzswRUFBNkI7SUFHbkI7UUFBakIsTUFBTSxDQUFDLFFBQVEsQ0FBQzs7cUVBQTJEO0lBRTdDO1FBQTlCLFlBQVksQ0FBQyxlQUFlLENBQUM7MENBQWUsU0FBUztvRUFBa0I7SUFDNUI7UUFBM0MsWUFBWSxDQUFDLFdBQVcsRUFBRSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUMsQ0FBQzs7a0VBQVk7SUFHdkQ7UUFEQyxLQUFLLEVBQUU7OztrRUFHUDtJQWdCRDtRQURDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7aURBQ3ZCLGFBQWE7OzJEQUV6QjtJQXBDVSwwQkFBMEI7UUFQdEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHFCQUFxQjtZQUMvQix5K0JBQStDO1lBRS9DLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO1lBQ3JDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOztTQUNoRCxDQUFDO2lEQXlCbUMsVUFBVTtPQXhCbEMsMEJBQTBCLENBaUd0QztJQUFELGlDQUFDO0NBQUEsQUFqR0QsSUFpR0M7U0FqR1ksMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGQsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgRWxlbWVudFJlZixcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFZpZXdDaGlsZHJlbixcbiAgUXVlcnlMaXN0LFxuICBIb3N0TGlzdGVuZXJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTWF0QnV0dG9uVG9nZ2xlIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvYnV0dG9uLXRvZ2dsZSc7XG5cbmltcG9ydCB7IFJ1ZkR5bmFtaWNTZWdtZW50SXRlbSB9IGZyb20gJy4vZHluYW1pYy1zZWdtZW50LWl0ZW0ubW9kZWwnO1xuaW1wb3J0IHsgUnVmS2V5Ym9hcmROYXZpZ2F0aW9uIH0gZnJvbSAnLi4vaW5wdXQva2V5Ym9hcmQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdydWYtZHluYW1pYy1zZWdtZW50JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2R5bmFtaWMtc2VnbWVudC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2R5bmFtaWMtc2VnbWVudC5jb21wb25lbnQuc2NzcyddLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBSdWZEeW5hbWljU2VnbWVudENvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBfa2V5Ym9hcmROYXY6IFJ1ZktleWJvYXJkTmF2aWdhdGlvbjtcbiAgcHJpdmF0ZSBfc2VsZWN0ZWRQYXRoOiBzdHJpbmc7XG4gIHByaXZhdGUgYXRpdmVJdGVtQ2xpcDogYm9vbGVhbjtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb247XG5cbiAgQElucHV0KCkgaXRlbXM6IFJ1ZkR5bmFtaWNTZWdtZW50SXRlbVtdID0gW107XG4gIEBJbnB1dCgpIHNob3dBY3RpdmVJdGVtQ2xpcDogYm9vbGVhbjtcbiAgLyogdHNsaW50OmRpc2FibGU6bm8tb3V0cHV0LXJlbmFtZSAqL1xuICAvLyBSZW5hbWluZyBvdXRwdXQgdG8gYXZvaWQgZHVwbGljYXRlIGBzZWxlY3RgIGlkZW50aWZpZXJzXG4gIEBPdXRwdXQoJ3NlbGVjdCcpIHNlbGVjdEVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPFJ1ZkR5bmFtaWNTZWdtZW50SXRlbT4oKTtcblxuICBAVmlld0NoaWxkcmVuKE1hdEJ1dHRvblRvZ2dsZSkgc2VnbWVudEl0ZW1zOiBRdWVyeUxpc3Q8TWF0QnV0dG9uVG9nZ2xlPjtcbiAgQENvbnRlbnRDaGlsZChUZW1wbGF0ZVJlZiwge3N0YXRpYzogZmFsc2V9KSBuYXZBY3Rpb25zO1xuXG4gIEBJbnB1dCgpXG4gIHNldCBzZWxlY3RlZFBhdGgoaWQ6IHN0cmluZykge1xuICAgIHRoaXMuX3NlbGVjdGVkUGF0aCA9IGlkO1xuICB9XG5cbiAgZ2V0IHNlbGVjdGVkUGF0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2VsZWN0ZWRQYXRoO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIF9lbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7IH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5hZGROZXdLZXlib2FyZE5hdigpO1xuICAgIHRoaXMuc2VnbWVudEl0ZW1zLmNoYW5nZXMuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuYWRkTmV3S2V5Ym9hcmROYXYoKTtcbiAgICB9KTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuICBvbktleShldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIHRoaXMuX2tleWJvYXJkTmF2Lm9uS2V5RG93bihldmVudCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMuc2VsZWN0ZWRQYXRoICYmIGNoYW5nZXMuc2VsZWN0ZWRQYXRoLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgdGhpcy5zZWxlY3RTZWdtZW50SXRlbSh7cGF0aDogY2hhbmdlcy5zZWxlY3RlZFBhdGguY3VycmVudFZhbHVlfSk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8vIFNldCBLZXlib2FyZCBuYXZpZ2F0aW9uXG4gIGFkZE5ld0tleWJvYXJkTmF2KCkge1xuICAgIHRoaXMuX2tleWJvYXJkTmF2ID0gbmV3IFJ1ZktleWJvYXJkTmF2aWdhdGlvbigpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5fa2V5Ym9hcmROYXYuaW5pdCh0aGlzLl9lbGVtZW50UmVmLCB0aGlzLnNlZ21lbnRJdGVtcykuc3Vic2NyaWJlKGl0ZW0gPT4ge1xuICAgICAgdGhpcy5zZWxlY3RTZWdtZW50SXRlbSh7cGF0aDogaXRlbS52YWx1ZX0pO1xuICAgIH0pO1xuICAgIHRoaXMuX2tleWJvYXJkTmF2LmFkZFRhYkluZGV4KHRoaXMuc2VnbWVudEl0ZW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgc2VsZWN0ZWRQYXRoIGFuZCBhY3RpdmF0ZSBkeW5hbWljLXNlZ21lbnQgaXRlbVxuICAgKiBAcGFyYW0gaXRlbVxuICAgKi9cbiAgc2VsZWN0U2VnbWVudEl0ZW0oaXRlbTogUnVmRHluYW1pY1NlZ21lbnRJdGVtKSB7XG4gICAgdGhpcy5fc2VsZWN0ZWRQYXRoID0gaXRlbS5wYXRoO1xuICAgIGNvbnN0IHNlbGVjdGVkSW5kZXggPSB0aGlzLnNlbGVjdGVkSW5kZXgoKTtcbiAgICBpZiAodGhpcy5fa2V5Ym9hcmROYXYpIHtcbiAgICAgIHRoaXMuX2tleWJvYXJkTmF2LnNldEFjdGl2ZUl0ZW0oKHNlbGVjdGVkSW5kZXggPT09IC0xKSA/IDAgOiBzZWxlY3RlZEluZGV4KTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc2VnbWVudEl0ZW1zKSB7XG4gICAgICAvLyBpZiBzZWdtZW50SXRlbXMgYXJlIG5vdCBwcmVzZW50LCB0aGUgY29tcG9uZW50IHZpZXcgaXMgbm90IGxvYWRlZCB5ZXQuXG4gICAgICAvLyBUaGlzIG1lYW5zICdzZWxlY3RTZWdtZW50SXRlbScgaXMgY2FsbGVkIGZyb20gJ25nT25DaGFuZ2VzJyBhbmQgdGhlIGhvc3QgZWxlbWVudCBoYXMgW3NlbGVjdGVkUGF0aF0gaW5wdXQuXG4gICAgICBjb25zdCBzZWxlY3RlZEl0ZW0gPSAoc2VsZWN0ZWRJbmRleCA9PT0gLTEpID8gbnVsbCA6IHRoaXMuaXRlbXNbc2VsZWN0ZWRJbmRleF07XG4gICAgICB0aGlzLnNlbGVjdEVtaXR0ZXIuZW1pdChzZWxlY3RlZEl0ZW0pO1xuICAgIH1cblxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIC0gaW5kZXggb2YgdGhlIHNlbGVjdGVkIGR5bmFtaWMtc2VnbWVudCBpdGVtLiAtMSBpZiBubyBkeW5hbWljLXNlZ21lbnQgaXMgc2VsZWN0ZWQuXG4gICAqL1xuICBzZWxlY3RlZEluZGV4KCk6IG51bWJlciB7XG4gICAgbGV0IGluZGV4ID0gLTE7XG4gICAgaWYgKHRoaXMuc2VnbWVudEl0ZW1zKSB7XG4gICAgICBpbmRleCA9IHRoaXMuaXRlbXMuZmluZEluZGV4KCAoc2VnbWVudEl0ZW0sIGkpID0+IHRoaXMuX21hdGNoZXMoc2VnbWVudEl0ZW0ucGF0aCkpO1xuICAgIH1cbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICBwcml2YXRlIF9tYXRjaGVzKHBhdGg6IHN0cmluZykge1xuICAgIGlmIChwYXRoICYmIHRoaXMuc2VsZWN0ZWRQYXRoKSB7XG4gICAgICBjb25zdCBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXigoXFwvKT8nICsgdGhpcy5zZWxlY3RlZFBhdGggKyAnKShcXC8uKik/JCcpOyAgLy8gdXNlIHdvcmQgYm91bmRhcnkgdG8gZXhhY3QgbWF0Y2hcbiAgICAgIGlmIChwYXRoID09PSB0aGlzLnNlbGVjdGVkUGF0aCB8fCBwYXR0ZXJuLnRlc3QocGF0aCkpIHsgLy8gbWF0Y2ggd2l0aCBhbmQgcGFyZW50IGR5bmFtaWMtc2VnbWVudCBpdGVtXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxufVxuIl19