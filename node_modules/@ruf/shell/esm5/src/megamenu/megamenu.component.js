import * as tslib_1 from "tslib";
import { RufSidemenuComponent } from './../sidemenu/sidemenu.component';
import { RufSearchService } from './menu-search.service';
import { ChangeDetectorRef, Component, Input, Output, EventEmitter, ViewEncapsulation, ViewChild, ChangeDetectionStrategy } from '@angular/core';
import { Subject, merge, of } from 'rxjs';
import { debounceTime, distinctUntilChanged, map, startWith, switchMap, withLatestFrom } from 'rxjs/operators';
import { RufShellIntl } from '../utils/shell-intl';
var RufMegamenuComponent = /** @class */ (function () {
    function RufMegamenuComponent(searchService, _intl, changeDetectorRef) {
        this.searchService = searchService;
        this._intl = _intl;
        this.items = [];
        this.select = new EventEmitter();
        // Subjects: denotes user interaction streams
        // search related properties
        this.searchTerms$ = new Subject(); // stream of search terms
        // sidemenu select event stream
        this.selectedSidemenuItems$ = new Subject(); // stream of selected items (same type has this.items)
        this.preparedSearchableItems = function (term) { return []; };
        this._intlChanges = _intl.changes.subscribe(function () { return changeDetectorRef.markForCheck(); });
    }
    Object.defineProperty(RufMegamenuComponent.prototype, "searchPlaceholder", {
        get: function () {
            return this._searchPlaceholder || this._intl.megamenu.placeholder;
        },
        set: function (value) {
            this._searchPlaceholder = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RufMegamenuComponent.prototype, "clearSearchAriaLabel", {
        get: function () {
            return this._clearSearchAriaLabel || this._intl.megamenu.aria.clearSearchLabel;
        },
        set: function (value) {
            this._clearSearchAriaLabel = value;
        },
        enumerable: true,
        configurable: true
    });
    RufMegamenuComponent.prototype.ngOnInit = function () {
        var _this = this;
        // map search terms to a search results stream ready to be consumed by sitemap
        var searchResults$ = this.searchTerms$.pipe(distinctUntilChanged(), debounceTime(400), // don't search unless user stopped typing for 400ms
        switchMap(function (term) { return _this.search(term); }), // ignore already triggered searches.
        startWith([])); // start with empty results
        // map sidemenu select event to selected item's children array
        var selectedItemChildren$ = this.selectedSidemenuItems$.pipe(withLatestFrom(searchResults$), // combine each event with the latest of the searchResults$ stream
        map(function (_a) {
            var _b = tslib_1.__read(_a, 2), item = _b[0], searchResults = _b[1];
            if (!item) {
                return searchResults || [];
            }
            // map to the selected item's children or an empty array.
            return item.data || [];
        }));
        // sitemap data stream is a merge of search results and selected item's children streams
        this.sitemapItems$ = merge(selectedItemChildren$, searchResults$);
    };
    RufMegamenuComponent.prototype.ngOnChanges = function (changes) {
        // when any changes to the items occur, re-prepare the search
        if (changes.items && changes.items.currentValue) {
            this.preparedSearchableItems = this.searchService.prepareSearch(changes.items.currentValue);
        }
    };
    RufMegamenuComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        // once the sidemenu is created (after view init), select first sidemenu item
        setTimeout(function () {
            if (_this.items[0]) {
                _this.sidemenu.select(_this.items[0].path, _this.items[0].children);
            }
        });
    };
    RufMegamenuComponent.prototype.search = function (term) {
        var results = this.items;
        // if no prepared searchable data is available we just return everything
        if (this.preparedSearchableItems) {
            // now we process the searching of the data
            results = this.preparedSearchableItems(term);
        }
        if (!term || term === '') {
            results = [];
        }
        // return observable of results using same type has this.item
        return of(results);
    };
    RufMegamenuComponent.prototype.ngOnDestroy = function () {
        this._intlChanges.unsubscribe();
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String),
        tslib_1.__metadata("design:paramtypes", [String])
    ], RufMegamenuComponent.prototype, "searchPlaceholder", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String),
        tslib_1.__metadata("design:paramtypes", [String])
    ], RufMegamenuComponent.prototype, "clearSearchAriaLabel", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], RufMegamenuComponent.prototype, "items", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], RufMegamenuComponent.prototype, "select", void 0);
    tslib_1.__decorate([
        ViewChild('sidemenu', { static: true }),
        tslib_1.__metadata("design:type", RufSidemenuComponent)
    ], RufMegamenuComponent.prototype, "sidemenu", void 0);
    RufMegamenuComponent = tslib_1.__decorate([
        Component({
            selector: 'ruf-megamenu',
            template: "<div class=\"ruf-sidemenu-container\">\n  <ruf-megamenu-search (filterValue)=\"searchTerms$.next($event)\" (inputFocus)=\"selectedSidemenuItems$.next()\" [placeholder]=\"searchPlaceholder\" [clearSearchLabel]=\"clearSearchAriaLabel\"></ruf-megamenu-search>\n  <ruf-sidemenu #sidemenu [selectedPath]=\"(selectedSidemenuItems$ | async)?.path\" (select)=\"selectedSidemenuItems$.next($event);\">\n    <ruf-sidemenu-item *ngFor=\"let item of items\" [path]=\"item.path\" [data]=\"item.children\">{{item.label}}</ruf-sidemenu-item>\n  </ruf-sidemenu>\n</div>\n<div class=\"ruf-sitemap-container\">\n  <ruf-sitemap [items]=\"sitemapItems$\" (select)=\"select.emit($event)\">\n  </ruf-sitemap>\n</div>\n",
            encapsulation: ViewEncapsulation.None,
            changeDetection: ChangeDetectionStrategy.OnPush,
            providers: [RufSearchService],
            styles: ["ruf-megamenu{display:-webkit-box;display:flex;flex-shrink:0;overflow-x:auto;padding:20px 20px 20px 0;width:100%}ruf-megamenu .ruf-sidemenu-container{height:100%;max-width:200px;min-width:200px;overflow-x:hidden;overflow-y:auto}ruf-megamenu .ruf-sidemenu-container ruf-sidemenu{flex-shrink:0;min-width:200px}ruf-megamenu .fis-search-input-container,ruf-megamenu .ruf-focus{border-left-style:solid;border-left-width:2px}ruf-megamenu .ruf-sitemap-container{border-style:solid;border-width:20px;display:-webkit-box;display:flex;-webkit-box-flex:1;flex:1 1 auto}ruf-megamenu .ruf-sidemenu-container::-webkit-scrollbar{width:.5em}ruf-megamenu ruf-sitemap{padding:18px}ruf-megamenu::-webkit-scrollbar{height:.5em}"]
        }),
        tslib_1.__metadata("design:paramtypes", [RufSearchService, RufShellIntl, ChangeDetectorRef])
    ], RufMegamenuComponent);
    return RufMegamenuComponent;
}());
export { RufMegamenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVnYW1lbnUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ1Zi9zaGVsbC8iLCJzb3VyY2VzIjpbInNyYy9tZWdhbWVudS9tZWdhbWVudS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXpELE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLGlCQUFpQixFQUlqQixTQUFTLEVBQ1QsdUJBQXVCLEVBR3hCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBa0IsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUNMLFlBQVksRUFDWixvQkFBb0IsRUFDcEIsR0FBRyxFQUNILFNBQVMsRUFDVCxTQUFTLEVBQ1QsY0FBYyxFQUNmLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBVW5EO0lBbUNFLDhCQUFxQixhQUErQixFQUFVLEtBQW1CLEVBQUUsaUJBQW9DO1FBQWxHLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQUFVLFVBQUssR0FBTCxLQUFLLENBQWM7UUFmeEUsVUFBSyxHQUFvQixFQUFFLENBQUM7UUFDM0IsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFpQixDQUFDO1FBSXJELDZDQUE2QztRQUM3Qyw0QkFBNEI7UUFDNUIsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDLENBQUMseUJBQXlCO1FBQy9ELCtCQUErQjtRQUMvQiwyQkFBc0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDLENBQUMsc0RBQXNEO1FBSTNGLDRCQUF1QixHQUFzQyxVQUFDLElBQUksSUFBSyxPQUFB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M0MsT0FBTyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QztRQUNELElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxLQUFLLEVBQUUsRUFBRTtZQUN4QixPQUFPLEdBQUcsRUFBRSxDQUFDO1NBQ2Q7UUFDRCw2REFBNkQ7UUFDN0QsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVBLDBDQUFXLEdBQVg7UUFDQyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUE3RkQ7UUFEQyxLQUFLLEVBQUU7OztpRUFHUDtJQU1EO1FBREMsS0FBSyxFQUFFOzs7b0VBR1A7SUFLUTtRQUFSLEtBQUssRUFBRTs7dURBQTZCO0lBQzNCO1FBQVQsTUFBTSxFQUFFOzt3REFBNEM7SUFFZDtRQUF0QyxTQUFTLENBQUMsVUFBVSxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDOzBDQUFXLG9CQUFvQjswREFBQztJQXZCM0Qsb0JBQW9CO1FBUmhDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxjQUFjO1lBQ3hCLG9zQkFBd0M7WUFFeEMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7WUFDckMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07WUFDL0MsU0FBUyxFQUFFLENBQUMsZ0JBQWdCLENBQUM7O1NBQzlCLENBQUM7aURBb0NvQyxnQkFBZ0IsRUFBaUIsWUFBWSxFQUFxQixpQkFBaUI7T0FuQzVHLG9CQUFvQixDQW1HaEM7SUFBRCwyQkFBQztDQUFBLEFBbkdELElBbUdDO1NBbkdZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJ1ZlNpZGVtZW51Q29tcG9uZW50IH0gZnJvbSAnLi8uLi9zaWRlbWVudS9zaWRlbWVudS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUnVmU2VhcmNoU2VydmljZSB9IGZyb20gJy4vbWVudS1zZWFyY2guc2VydmljZSc7XG5pbXBvcnQgeyBSdWZTZWFyY2hJdGVtIH0gZnJvbSAnLi9zZWFyY2gvc2VhcmNoaXRlbS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgT25Jbml0LFxuICBPbkRlc3Ryb3ksXG4gIEFmdGVyVmlld0luaXQsXG4gIFZpZXdDaGlsZCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIG1lcmdlLCBvZiAsICBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRlYm91bmNlVGltZSxcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIG1hcCxcbiAgc3RhcnRXaXRoLFxuICBzd2l0Y2hNYXAsXG4gIHdpdGhMYXRlc3RGcm9tXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJ1ZlNoZWxsSW50bCB9IGZyb20gJy4uL3V0aWxzL3NoZWxsLWludGwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdydWYtbWVnYW1lbnUnLFxuICB0ZW1wbGF0ZVVybDogJy4vbWVnYW1lbnUuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9tZWdhbWVudS5jb21wb25lbnQuc2NzcyddLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgcHJvdmlkZXJzOiBbUnVmU2VhcmNoU2VydmljZV1cbn0pXG5leHBvcnQgY2xhc3MgUnVmTWVnYW1lbnVDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBfaW50bENoYW5nZXM6IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBfc2VhcmNoUGxhY2Vob2xkZXI6IHN0cmluZztcbiAgcHJpdmF0ZSBfY2xlYXJTZWFyY2hBcmlhTGFiZWw6IHN0cmluZztcbiAgQElucHV0KClcbiAgZ2V0IHNlYXJjaFBsYWNlaG9sZGVyKCkge1xuICAgIHJldHVybiB0aGlzLl9zZWFyY2hQbGFjZWhvbGRlciB8fCB0aGlzLl9pbnRsLm1lZ2FtZW51LnBsYWNlaG9sZGVyO1xuICB9XG4gIHNldCBzZWFyY2hQbGFjZWhvbGRlcih2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5fc2VhcmNoUGxhY2Vob2xkZXIgPSB2YWx1ZTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIGdldCBjbGVhclNlYXJjaEFyaWFMYWJlbCgpIHtcbiAgICByZXR1cm4gdGhpcy5fY2xlYXJTZWFyY2hBcmlhTGFiZWwgfHwgdGhpcy5faW50bC5tZWdhbWVudS5hcmlhLmNsZWFyU2VhcmNoTGFiZWw7XG4gIH1cbiAgc2V0IGNsZWFyU2VhcmNoQXJpYUxhYmVsKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9jbGVhclNlYXJjaEFyaWFMYWJlbCA9IHZhbHVlO1xuICB9XG5cbiAgQElucHV0KCkgaXRlbXM6IFJ1ZlNlYXJjaEl0ZW1bXSA9IFtdO1xuICBAT3V0cHV0KCkgc2VsZWN0ID0gbmV3IEV2ZW50RW1pdHRlcjxSdWZTZWFyY2hJdGVtPigpO1xuXG4gIEBWaWV3Q2hpbGQoJ3NpZGVtZW51Jywge3N0YXRpYzogdHJ1ZX0pIHNpZGVtZW51OiBSdWZTaWRlbWVudUNvbXBvbmVudDtcblxuICAvLyBTdWJqZWN0czogZGVub3RlcyB1c2VyIGludGVyYWN0aW9uIHN0cmVhbXNcbiAgLy8gc2VhcmNoIHJlbGF0ZWQgcHJvcGVydGllc1xuICBzZWFyY2hUZXJtcyQgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7IC8vIHN0cmVhbSBvZiBzZWFyY2ggdGVybXNcbiAgLy8gc2lkZW1lbnUgc2VsZWN0IGV2ZW50IHN0cmVhbVxuICBzZWxlY3RlZFNpZGVtZW51SXRlbXMkID0gbmV3IFN1YmplY3Q8YW55PigpOyAvLyBzdHJlYW0gb2Ygc2VsZWN0ZWQgaXRlbXMgKHNhbWUgdHlwZSBoYXMgdGhpcy5pdGVtcylcbiAgLy8gbWVyZ2Ugc2VhcmNoIHJlc3VsdHMgYW5kIHNlbGVjdGVkIG1lbnUgaXRlbSdzIGNoaWxkcmVuIGludG8gYSBzaW5nbGUgc3RyZWFtXG4gIHNpdGVtYXBJdGVtcyQ6IE9ic2VydmFibGU8UnVmU2VhcmNoSXRlbVtdPjsgLy8gdXNlIHNhbWUgdHlwZSBoYXMgdGhpcy5pdGVtc1xuXG4gIHByaXZhdGUgcHJlcGFyZWRTZWFyY2hhYmxlSXRlbXM6ICh0ZXJtOiBzdHJpbmcpID0+IFJ1ZlNlYXJjaEl0ZW1bXSA9ICh0ZXJtKSA9PiBbXTtcblxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBzZWFyY2hTZXJ2aWNlOiBSdWZTZWFyY2hTZXJ2aWNlLCBwcml2YXRlIF9pbnRsOiBSdWZTaGVsbEludGwsIGNoYW5nZURldGVjdG9yUmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge1xuICAgIHRoaXMuX2ludGxDaGFuZ2VzID0gX2ludGwuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4gY2hhbmdlRGV0ZWN0b3JSZWYubWFya0ZvckNoZWNrKCkpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgLy8gbWFwIHNlYXJjaCB0ZXJtcyB0byBhIHNlYXJjaCByZXN1bHRzIHN0cmVhbSByZWFkeSB0byBiZSBjb25zdW1lZCBieSBzaXRlbWFwXG4gICAgY29uc3Qgc2VhcmNoUmVzdWx0cyQgPSB0aGlzLnNlYXJjaFRlcm1zJC5waXBlKFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIGRlYm91bmNlVGltZSg0MDApLCAvLyBkb24ndCBzZWFyY2ggdW5sZXNzIHVzZXIgc3RvcHBlZCB0eXBpbmcgZm9yIDQwMG1zXG4gICAgICBzd2l0Y2hNYXAodGVybSA9PiB0aGlzLnNlYXJjaCh0ZXJtKSksIC8vIGlnbm9yZSBhbHJlYWR5IHRyaWdnZXJlZCBzZWFyY2hlcy5cbiAgICAgIHN0YXJ0V2l0aChbXSlcbiAgICAgICk7IC8vIHN0YXJ0IHdpdGggZW1wdHkgcmVzdWx0c1xuXG4gICAgLy8gbWFwIHNpZGVtZW51IHNlbGVjdCBldmVudCB0byBzZWxlY3RlZCBpdGVtJ3MgY2hpbGRyZW4gYXJyYXlcbiAgICBjb25zdCBzZWxlY3RlZEl0ZW1DaGlsZHJlbiQgPSB0aGlzLnNlbGVjdGVkU2lkZW1lbnVJdGVtcyQucGlwZShcbiAgICAgIHdpdGhMYXRlc3RGcm9tKHNlYXJjaFJlc3VsdHMkKSwgLy8gY29tYmluZSBlYWNoIGV2ZW50IHdpdGggdGhlIGxhdGVzdCBvZiB0aGUgc2VhcmNoUmVzdWx0cyQgc3RyZWFtXG4gICAgICBtYXAoKFtpdGVtLCBzZWFyY2hSZXN1bHRzXSkgPT4ge1xuICAgICAgICBpZiAoIWl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gc2VhcmNoUmVzdWx0cyB8fCBbXTtcbiAgICAgICAgfVxuICAgICAgICAvLyBtYXAgdG8gdGhlIHNlbGVjdGVkIGl0ZW0ncyBjaGlsZHJlbiBvciBhbiBlbXB0eSBhcnJheS5cbiAgICAgICAgcmV0dXJuIGl0ZW0uZGF0YSB8fCBbXTtcbiAgICAgIH0pKTtcblxuICAgIC8vIHNpdGVtYXAgZGF0YSBzdHJlYW0gaXMgYSBtZXJnZSBvZiBzZWFyY2ggcmVzdWx0cyBhbmQgc2VsZWN0ZWQgaXRlbSdzIGNoaWxkcmVuIHN0cmVhbXNcbiAgICB0aGlzLnNpdGVtYXBJdGVtcyQgPSBtZXJnZShcbiAgICAgIHNlbGVjdGVkSXRlbUNoaWxkcmVuJCxcbiAgICAgIHNlYXJjaFJlc3VsdHMkXG4gICAgKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAvLyB3aGVuIGFueSBjaGFuZ2VzIHRvIHRoZSBpdGVtcyBvY2N1ciwgcmUtcHJlcGFyZSB0aGUgc2VhcmNoXG4gICAgaWYgKGNoYW5nZXMuaXRlbXMgJiYgY2hhbmdlcy5pdGVtcy5jdXJyZW50VmFsdWUpIHtcbiAgICAgIHRoaXMucHJlcGFyZWRTZWFyY2hhYmxlSXRlbXMgPSB0aGlzLnNlYXJjaFNlcnZpY2UucHJlcGFyZVNlYXJjaChjaGFuZ2VzLml0ZW1zLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIC8vIG9uY2UgdGhlIHNpZGVtZW51IGlzIGNyZWF0ZWQgKGFmdGVyIHZpZXcgaW5pdCksIHNlbGVjdCBmaXJzdCBzaWRlbWVudSBpdGVtXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5pdGVtc1swXSkge1xuICAgICAgICB0aGlzLnNpZGVtZW51LnNlbGVjdCh0aGlzLml0ZW1zWzBdLnBhdGgsIHRoaXMuaXRlbXNbMF0uY2hpbGRyZW4pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWFyY2godGVybTogc3RyaW5nKTogT2JzZXJ2YWJsZTxSdWZTZWFyY2hJdGVtW10+IHtcbiAgICBsZXQgcmVzdWx0cyA9IHRoaXMuaXRlbXM7XG4gICAgLy8gaWYgbm8gcHJlcGFyZWQgc2VhcmNoYWJsZSBkYXRhIGlzIGF2YWlsYWJsZSB3ZSBqdXN0IHJldHVybiBldmVyeXRoaW5nXG4gICAgaWYgKHRoaXMucHJlcGFyZWRTZWFyY2hhYmxlSXRlbXMpIHtcbiAgICAgIC8vIG5vdyB3ZSBwcm9jZXNzIHRoZSBzZWFyY2hpbmcgb2YgdGhlIGRhdGFcbiAgICAgIHJlc3VsdHMgPSB0aGlzLnByZXBhcmVkU2VhcmNoYWJsZUl0ZW1zKHRlcm0pO1xuICAgIH1cbiAgICBpZiAoIXRlcm0gfHwgdGVybSA9PT0gJycpIHtcbiAgICAgIHJlc3VsdHMgPSBbXTtcbiAgICB9XG4gICAgLy8gcmV0dXJuIG9ic2VydmFibGUgb2YgcmVzdWx0cyB1c2luZyBzYW1lIHR5cGUgaGFzIHRoaXMuaXRlbVxuICAgIHJldHVybiBvZihyZXN1bHRzKTtcbiAgfVxuXG4gICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLl9pbnRsQ2hhbmdlcy51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=