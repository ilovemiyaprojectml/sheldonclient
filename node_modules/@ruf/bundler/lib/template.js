"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const lodash_1 = require("lodash");
const execa = require("execa");
const dependency_manager_1 = require("./dependency-manager");
const os_1 = require("os");
const child_process_1 = require("child_process");
const isWin = os_1.platform() === 'win32';
const BUILD_ARG_REGEX = /(?:\$\{)(hash)(?:\})/g;
const ASSETS_DIR = 'assets';
const util_1 = require("./util");
function err(msg) {
    const prefix = 'BUILD INPUT: ';
    return new Error(`${prefix}${msg}`);
}
let _templates = [];
class Template {
    constructor(name, dependencyManager = new dependency_manager_1.DependencyManager()) {
        this.name = name;
        this.dependencyManager = dependencyManager;
        this.counter = 0;
        this.templateSrc = path_1.resolve(__dirname, '../templates/', name);
        const { exportProjectTo, htmlTemplate, dist } = require(path_1.join(this.templateSrc, 'ruf-bundler.json'));
        this.exportProjectTo = exportProjectTo;
        this.htmlTemplate = htmlTemplate;
        this.dist = dist;
        const { dependencies, devDependencies } = require(path_1.join(this.templateSrc, 'package.json'));
        this.dependencies = dependencies;
        this.devDependencies = devDependencies;
    }
    static getTemplateNames() {
        return __awaiter(this, void 0, void 0, function* () {
            if (_templates.length === 0) {
                _templates = yield util_1.getDirs(path_1.resolve(__dirname, '../templates'));
            }
            return _templates;
        });
    }
    getHtmlTemplateData() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this._htmlTemplateData) {
                return this._htmlTemplateData;
            }
            return util_1.readFile(path_1.join(this.templateSrc, this.htmlTemplate)).then(data => {
                this._htmlTemplateData = lodash_1.template(data.toString(), {
                    interpolate: /{([\s\S]+?)}/g
                });
                return this._htmlTemplateData;
            });
        });
    }
    _createTmpWorkspace(opts) {
        return __awaiter(this, void 0, void 0, function* () {
            const ws = opts.workspace || util_1.tmpdir();
            const tmp = path_1.join(ws, `ruf-bundler-${new Date().getTime()}-${this.counter++}`);
            return yield util_1.copy(this.templateSrc, tmp).then(_ => tmp);
        });
    }
    validateSettings(settings) {
        return __awaiter(this, void 0, void 0, function* () {
            const { template, title, description, tags, dependencies, files } = settings;
            const templateNames = yield Template.getTemplateNames();
            if (!templateNames.includes(template)) {
                throw err(`unknown project template ${template}`);
            }
            if (!util_1.isString(title)) {
                throw err(`a title must be provided`);
            }
            if (!util_1.isObject(files)) {
                throw err('files must be an object mapping filenames to file contents.');
            }
            if (dependencies && !util_1.isObject(dependencies)) {
                throw err('dependencies must be an object mapping npm package names to package versions.');
            }
            if (tags) {
                if (!util_1.isArray(tags)) {
                    throw err('tags must be an array of strings');
                }
                if (tags.some(v => !util_1.isString(v))) {
                    throw err('tags must be an array of strings');
                }
            }
            const filenames = Object.keys(files);
            if (!filenames.includes('index.html')) {
                throw err('index.html must be present in files.');
            }
            for (const name of filenames) {
                if (name.includes('..') || path_1.isAbsolute(name)) {
                    throw err(`invalid filename: ${name}`);
                }
                if (!util_1.isString(files[name])) {
                    throw err(`contents of file named ${name} must be a string`);
                }
            }
            return {
                template,
                title,
                description: description || '',
                tags: tags || [],
                dependencies: dependencies || {},
                files
            };
        });
    }
    getHash(obj) {
        return util_1.getHash(obj);
    }
    getTotalSteps(opts, settings) {
        let totalSteps = 8;
        if (opts.templateChanges) {
            totalSteps++;
        }
        if (settings.dependencies) {
            totalSteps++;
        }
        if (opts.packageManager === 'npm') {
            totalSteps = totalSteps + 4;
        }
        return totalSteps;
    }
    build(settings, opts = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            let step = 0;
            const total = this.getTotalSteps(opts, settings);
            const progress = opts.progress
                ? (msg, hashValue, done) => {
                    opts.progress([++step, total, msg, hashValue, !!done]);
                }
                : util_1.noop;
            const buildPlan = opts.buildPlan || util_1.noop;
            let buildFlags = opts.buildFlags;
            const buildParams = {};
            opts.packageManager = opts.packageManager || 'pnpm';
            console.log(`Using package manager - ${opts.packageManager}`);
            let destination = opts.destination || util_1.tmpdir();
            settings = yield this.validateSettings(settings);
            const hash = util_1.getHash(settings);
            const workspacePath = yield this._createTmpWorkspace(opts);
            if (opts.useHashDir) {
                buildParams.hash = hash;
                destination = path_1.join(destination, hash);
                if (opts.returnIfExists) {
                    const alreadyBuilt = yield util_1.exists(destination);
                    if (alreadyBuilt) {
                        buildPlan({ destination, alreadyBuilt, hash });
                        return destination;
                    }
                }
            }
            progress('Preparing workspace.', hash);
            buildPlan({ destination, hash, workspacePath, alreadyBuilt: false });
            if (opts.packageManager === 'npm') {
                let nodeModulesPath = yield this.dependencyManager.getNodeModulesPathForTemplate(this, settings.dependencies, { progress: progress }, hash);
                progress('Linking node modules with pnpm and back.', hash);
                nodeModulesPath = isWin ? path_1.resolve(nodeModulesPath) : nodeModulesPath;
                yield util_1.symlink(path_1.resolve(nodeModulesPath), path_1.join(workspacePath, 'node_modules'), 'junction');
            }
            progress('Exporting files to project.', hash);
            settings.files = settings.files || {};
            const toWrite = Object.keys(settings.files).map(key => [
                path_1.join(workspacePath, this.exportProjectTo, key),
                settings.files[key]
            ]);
            for (const args of toWrite) {
                yield util_1.writeFileForce(args[0], args[1]);
            }
            progress('Generating main html template', hash);
            const compiledHtmlTemplate = yield this.getHtmlTemplateData();
            util_1.writeFile(path_1.join(workspacePath, this.htmlTemplate), compiledHtmlTemplate(Object.assign({}, settings, { BLITZ_TEMPLATE: settings.files['index.html'] })));
            if (settings.dependencies) {
                progress('Update package dependecies', hash);
                const pkg = require(path_1.join(workspacePath, 'package.json'));
                pkg.dependencies = Object.assign(pkg.dependencies, settings.dependencies);
                yield util_1.writeFile(path_1.join(workspacePath, 'package.json'), JSON.stringify(pkg, null, ' '));
            }
            if (opts.templateChanges) {
                progress('Processing template changes', hash);
                yield util_1.changeJSONFiles(workspacePath, opts.templateChanges.merge);
                yield util_1.linkDependencies(workspacePath, opts.templateChanges.npmlink, hash);
            }
            if (opts.packageManager !== 'npm') {
                progress('Installing dependencies. This may take a while.', hash);
                yield execa(path_1.resolve(__dirname, '../node_modules/.bin/pnpm'), ['install'], {
                    cwd: workspacePath
                }).catch((npmErr) => {
                    progress('Package dependencies installation failed!', hash);
                    throw new util_1.DetailedError('Dependency installation failed', npmErr.message, hash);
                });
            }
            progress('Building project.', hash);
            let command = ['run', 'build'];
            if (buildFlags) {
                if (BUILD_ARG_REGEX.test(buildFlags)) {
                    buildFlags = buildFlags.replace(BUILD_ARG_REGEX, function (match, capture) {
                        return buildParams[capture];
                    });
                }
                command.push('--');
                command = command.concat(buildFlags.split(' '));
            }
            yield execa('npm', command, {
                cwd: workspacePath
            }).catch((npmErr) => {
                progress('Build failed!', hash);
                throw new util_1.DetailedError('Build failed', npmErr.message, hash);
            });
            progress('Build successful!', hash);
            progress('Copying to destination and cleanup.', hash);
            yield util_1.mkdir(destination);
            yield util_1.move(path_1.join(workspacePath, this.dist), destination, {
                overwrite: true
            });
            const assetFiles = Object.keys(settings.files).filter(name => name.startsWith(`${ASSETS_DIR}/`));
            if (assetFiles && assetFiles.length > 0) {
                for (const asset of assetFiles) {
                    const key = asset.substr(asset.indexOf(`${ASSETS_DIR}/`) + `${ASSETS_DIR}/`.length);
                    yield util_1.mkdir(`${destination}/${path_1.dirname(key)}`);
                    yield util_1.writeFile(`${destination}/${key}`, settings.files[asset]);
                }
            }
            yield util_1.writeFile(path_1.join(destination, 'ruf-example.json'), JSON.stringify(settings, null, 2));
            progress('Done', hash, true);
            if (!opts.keepWorkspace) {
                const rmProcess = child_process_1.spawn(path_1.resolve(__dirname, '../node_modules/.bin/rimraf'), [workspacePath], {
                    shell: true
                });
                rmProcess.stderr.on('data', data => {
                    console.error(`Error deleting ${workspacePath}: ${data}`);
                });
                rmProcess.stdout.on('data', data => {
                    console.log(`${workspacePath} deleted successfully: ${data}`);
                });
                rmProcess.on('close', code => {
                    console.log(`child process exited with code ${code}`);
                });
            }
            return destination;
        });
    }
}
exports.Template = Template;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdGVtcGxhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLCtCQUEwRDtBQUUxRCxtQ0FBMkQ7QUFDM0QsK0JBQStCO0FBQy9CLDZEQUF5RDtBQUN6RCwyQkFBOEI7QUFDOUIsaURBQXNDO0FBRXRDLE1BQU0sS0FBSyxHQUFHLGFBQVEsRUFBRSxLQUFLLE9BQU8sQ0FBQztBQUNyQyxNQUFNLGVBQWUsR0FBRyx1QkFBdUIsQ0FBQztBQUNoRCxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUM7QUFFNUIsaUNBc0JnQjtBQUVoQixhQUFhLEdBQVc7SUFDdEIsTUFBTSxNQUFNLEdBQUcsZUFBZSxDQUFDO0lBQy9CLE9BQU8sSUFBSSxLQUFLLENBQUMsR0FBRyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBdUNELElBQUksVUFBVSxHQUFhLEVBQUUsQ0FBQztBQUU5QjtJQWtCRSxZQUNTLElBQVksRUFDWCxvQkFBdUMsSUFBSSxzQ0FBaUIsRUFBRTtRQUQvRCxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1gsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE2QztRQVpoRSxZQUFPLEdBQUcsQ0FBQyxDQUFDO1FBY2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsY0FBTyxDQUFDLFNBQVMsRUFBRSxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDN0QsTUFBTSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLFdBQUksQ0FDMUQsSUFBSSxDQUFDLFdBQVcsRUFDaEIsa0JBQWtCLENBQ25CLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpC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